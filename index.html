<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 初试全程复习计划｜倒计时 · 标签页 · 可自定义日程</title>
<style>
  :root{
    --bg:#0b1220;--panel:#121a2b;--panel-2:#0f1626;--text:#e6ecff;--muted:#9fb0d0;--brand:#6ea8fe;--ok:#54d39a;--warn:#ffc069;--danger:#ff6b6b;--border:#1e2a44;--chip:#1a2340;
    --shadow:0 8px 24px hsl(220 60% 4%/0.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  a{color:var(--brand);text-decoration:none}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;flex-direction:column;gap:16px;margin-bottom:16px}
  .title{font-weight:800;font-size:26px;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);color:#cfe0ff;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card + .card{margin-top:14px}
  .card h3{margin:0 0 12px;font-size:16px}
  .muted{color:var(--muted)}

  /* countdown */
  .countdown{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
  .timer{display:flex;gap:16px;flex-wrap:wrap}
  .box{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:10px 14px;min-width:110px;text-align:center}
  .box .num{font-size:32px;font-weight:800;letter-spacing:1px}
  .box .lab{font-size:12px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}
  .clickable{cursor:pointer}

  /* toolbar */
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn,select,input[type="date"],input[type="text"],input[type="month"]{background:var(--chip);color:#eaf1ff;border:1px solid var(--border);padding:8px 12px;border-radius:12px;outline:none}
  .btn{cursor:pointer;transition:.2s transform}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:#0f203e}
  .btn.ghost{background:transparent}

  /* tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .tab{cursor:pointer;border:1px solid var(--border);background:var(--chip);padding:8px 12px;border-radius:12px}
  .tab.active{background:var(--brand);color:#041534}
  .views{margin-top:14px}
  .view{display:none}
  .view.active{display:block}

  /* details cards */
  details{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  details+details{margin-top:10px}
  summary{cursor:pointer;user-select:none;list-style:none}
  summary::-webkit-details-marker{display:none}
  summary .ttl{display:flex;align-items:center;gap:10px}
  summary .wk{background:#0c1a33;border:1px solid var(--border);color:#cfe0ff;padding:2px 8px;border-radius:999px;font-size:12px}
  .tasks{margin:8px 0 0 0;padding-left:20px}
  .tasks li{margin:4px 0}
  .tag{display:inline-block;vertical-align:middle;background:#0f1e39;border:1px solid var(--border);color:#bed3ff;border-radius:999px;padding:2px 8px;font-size:11px;margin-right:6px}

  /* daily checklist */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){.grid{grid-template-columns:1fr}}
  .checklist{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .checklist h4{margin:0 0 8px}
  .item{display:flex;align-items:center;gap:10px;margin:6px 0}
  .item input[type="text"]{flex:1}
  .item .del{margin-left:auto}
  .item .del:hover{background:var(--danger)}
  .addline{display:flex;gap:8px;margin-top:8px}
  .schedule{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}

  /* subject grouped cards */
  .subject-cards details{margin-bottom:8px}
  .sub-summary{display:flex;align-items:center;gap:8px}
  .sub-progress{margin-left:auto;font-size:12px;color:var(--muted)}
  .sub-items .item{margin:8px 0}

  /* schedule editor */
  .sched-ctrls{display:flex;gap:8px;margin:8px 0}
  .sched-item{display:flex;align-items:center;gap:8px;margin:6px 0}
  .sched-item input.t{width:130px}
  .sched-item input.txt{flex:1}
  .sched-item .up,.sched-item .down,.sched-item .del{padding:6px 8px}

  /* calendar */
  .cal-head{display:flex;align-items:center;gap:10px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-top:12px}
  .cal-cell{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;min-height:110px;position:relative}
  .cal-cell .date{font-weight:700;opacity:.9}
  .cal-cell .stat{position:absolute;left:10px;bottom:10px;font-size:12px;color:var(--muted)}
  .cal-cell.out{opacity:.4}
  .cal-cell:hover{outline:1px solid var(--brand);cursor:pointer}

  .small{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e1a31;border:1px solid var(--border);border-radius:6px;padding:1px 6px;margin:0 2px}

  .sticky-top{position:sticky;top:8px;z-index:5}
  .right{margin-left:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">2025 初试全程复习计划（8.12 → 12.20）<span class="small">｜对象：生物专业（英二 / 政治 / 生化 / 分子生物 / 微生物）</span></div>
      <div class="sub" id="todayLine"></div>
      <div class="chips">
        <span class="chip">学习 6 天 + 1 天机动/复盘</span>
        <span class="chip">每日含固定运动：15:30–16:30</span>
        <span class="chip">错题本 & 速记册 & 滚动背诵</span>
        <span class="chip">周均 45–55h（可±10%）</span>
      </div>
    </header>

    <!-- Countdown Card -->
    <div class="card clickable" id="countCard" title="点击可折叠/展开">
      <h3>距离 <span id="examDateText"></span> 初试倒计时</h3>
      <div class="countdown">
        <div class="timer">
          <div class="box"><div class="num" id="d">--</div><div class="lab">天</div></div>
          <div class="box"><div class="num" id="h">--</div><div class="lab">小时</div></div>
          <div class="box"><div class="num" id="m">--</div><div class="lab">分钟</div></div>
          <div class="box"><div class="num" id="s">--</div><div class="lab">秒</div></div>
        </div>
        <div class="hint">倒计时时钟默认本地时间计算；默认以当天 00:00 为今日目标时间。</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="bar" style="margin:12px 0 4px">
      <label class="small">显示：</label>
      <select id="subjectFilter">
        <option value="all">全部科目</option>
        <option value="生化">生化</option>
        <option value="分子">分子</option>
        <option value="微生">微生</option>
        <option value="英语">英语</option>
        <option value="政治">政治</option>
        <option value="通用">通用</option>
      </select>
      <input type="text" id="searchBox" placeholder="搜索任务关键词（如：真题 / 36讲 / 背诵 / 复盘）" style="min-width:260px"/>
      <input type="date" id="datePick"/>
      <button class="btn" id="expandWeek">展开/折叠 本周</button>
      <button class="btn secondary" onclick="window.print()">打印/导出 PDF</button>
      <button class="btn ghost" id="clearAll">清除打卡记录</button>
    </div>

    <!-- Tabs -->
    <div class="tabs sticky-top">
      <div class="tab active" data-tab="day">日计划</div>
      <div class="tab" data-tab="week">周计划</div>
      <div class="tab" data-tab="month">月计划</div>
      <div class="tab" data-tab="dailytime">每日时间安排</div>
    </div>

    <div class="views">
      <!-- 日计划视图 -->
      <section class="view active" id="view-day">
        <div class="card">
          <h3>日计划 · <span id="dayTitle">—</span></h3>
          <div class="muted small">提示：自定义任务会以科目“<b>自定义</b>”保存；所有勾选状态与自定义项均保存在浏览器 <span class="kbd">localStorage</span> 中（同一设备/同一浏览器生效）。</div>
        </div>

        <details open class="card">
          <summary><div class="ttl"><span class="wk">自检&指南</span><b>自检结果（用于调试/可忽略）</b></div></summary>
          <div class="small" id="selfCheck"></div>
        </details>

        <div class="grid">
          <div class="checklist" id="dayGrouped">
            <h4>今日学习清单（按科目分组）</h4>
            <div id="subjectCards" class="subject-cards"></div>
            <div class="small" style="margin-top:6px">提示：每个科目卡片都可展开/收起；可在各科目底部添加自定义任务。</div>
          </div>

          <div class="schedule" id="daySchedule">
            <h4>今日作息 · 可自定义</h4>
            <div class="small">提示：作息同样保存到浏览器 <span class="kbd">localStorage</span>；可恢复模板或复制昨日。</div>
            <div class="sched-ctrls">
              <button class="btn" id="schedAdd">添加一行</button>
              <button class="btn secondary" id="schedReset">恢复模板</button>
              <button class="btn ghost" id="schedCopyPrev">用昨日作息</button>
            </div>
            <ol id="schedList"></ol>
          </div>
        </div>
      </section>

      <!-- 周计划视图 -->
      <section class="view" id="view-week">
        <div id="weekContainer"></div>
      </section>

      <!-- 月计划视图 -->
      <section class="view" id="view-month">
        <div class="card">
          <div class="cal-head">
            <h3 style="margin:0">月计划 · 打卡日历</h3>
            <span class="small">点击某一天可跳转到日计划</span>
            <div class="right"></div>
            <button class="btn" id="prevMonth">上个月</button>
            <input type="month" id="monthPick"/>
            <button class="btn" id="nextMonth">下个月</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
      </section>

      <!-- 每日时间表视图 -->
      <section class="view" id="view-dailytime">
        <div class="card">
          <h3>每日固定时间表（可按需微调，但保留 <b>15:30–16:30</b> 运动时段）</h3>
          <ul>
            <li>07:00 起床；07:20–08:00 英语晨读</li>
            <li>08:10–10:10 专业课A；10:25–12:00 专业课B</li>
            <li>12:00–14:00 午餐+午休</li>
            <li>14:00–15:20 政治</li>
            <li><b>15:30–16:30 运动/拉伸（固定）</b></li>
            <li>16:45–18:15 专业课C</li>
            <li>19:30–20:30 英语二；20:35–21:35 复盘背诵</li>
            <li>21:35–22:00 收尾；23:00 前就寝</li>
          </ul>
          <div class="small">在图书馆/宿舍学习可各自安排，但请保持“上午2h + 1.5h、下午 1.5h、傍晚 1.5h、晚间1–1.5h”的 4 块结构。</div>
        </div>
      </section>
    </div>
  </div>

<script>
// ====== 基础日期配置 ======
const START_DATE = new Date('2025-08-12T00:00:00');
const EXAM_DATE = new Date('2025-12-20T00:00:00');

// ====== 文案数据：月、周、日（周计划用于过滤/参考） ======
const monthPlan = [
  { title:'8 月（8/12–8/31） | 框架搭建 + 基础铺垫', items:[
    ['生化','细胞化学成分、酶、糖代谢上、脂代谢概论；建立“代谢通路图”。'],
    ['分子','DNA/染色体结构、复制与修复；转录入门。'],
    ['微生','微生物形态结构、营养生长、控制（消毒灭菌）。'],
    ['英语','长难句+语法精炼（每日30–45min）+阅读基础一篇/天。'],
    ['政治','马原精讲1轮（概念卡片）。'],
    ['通用','完成知识树 v1、错题本模板、英语高频词表。'],
  ]},
  { title:'9 月 | 强化基础 + 题感建立', items:[
    ['生化','糖/脂/蛋白/核苷酸代谢逐章强化+常见调控点。'],
    ['分子','转录、翻译、表达调控；分子技术（PCR、克隆、Blot）。'],
    ['微生','代谢与生化反应、细菌遗传、抗菌药物基础。'],
    ['英语','阅读技巧与完形；每周1次小作文。'],
    ['政治','毛中特+史纲精讲；刷选择题基础。'],
    ['通用','每周微测 1 次、错题按周复盘。'],
  ]},
  { title:'10 月 | 真题与考点锚定（一轮）', items:[
    ['生化','历年真题与配套卷，整理高频考点与易混点。'],
    ['分子','同上：按专题刷题，建立“考点-题目-页码”索引。'],
    ['微生','同上：微生/病毒/免疫相关专题真题。'],
    ['英语','真题阅读精做，对比解析；作文素材库搭建。'],
    ['政治','1000题系统刷；建立错题索引。'],
    ['通用','第一版考前速记册（A5）。'],
  ]},
  { title:'11 月 | 真题二轮 + 模拟卷 + 背诵强化', items:[
    ['专业课','错题二刷、每周 1–2 套模拟；背诵清单迭代。'],
    ['英语','作文模板固化+仿写；翻译&新题型穿插。'],
    ['政治','主观题框架+热点材料；整卷训练。'],
    ['通用','速记册第二版；错题闭环率≥90%'],
  ]},
  { title:'12 月 | 冲刺压轴', items:[
    ['专业课','背诵日更 + 终极错题第三刷；小型整卷节奏（隔日1套）。'],
    ['英语','作文押题与自拟题训练，每两天 1 篇。'],
    ['政治','终极套题（选择+大题），大题框架背诵。'],
    ['通用','考前三天转轻量背诵+手感维持。'],
  ]},
];

const weekPlan = [
  ['W1｜8/12–8/17（适应周）', [
    ['生化','酶、糖代谢概论；画代谢图雏形。'],
    ['分子','DNA 结构、复制与修复。'],
    ['微生','形态结构、增殖与培养。'],
    ['英语','长难句 6 讲，阅读 4 篇。'],
    ['政治','马原 1 章。'],
    ['通用','完成知识树 v1 与错题本模板。'],
  ]],
  ['W2｜8/18–8/24',[['生化','糖代谢（糖酵解/糖异生/糖原/Pentose）。'],['分子','转录基础（原核/真核差异）。'],['微生','控制与消毒灭菌；无菌操作。'],['英语','阅读 6 篇；作文素材库开建。'],['政治','马原 2 章 + 日常选择。']]],
  ['W3｜8/25–8/31',[['生化','脂代谢（β-氧化、合成、酮体、胆固醇）。'],['分子','翻译与后修饰。'],['微生','代谢与能量；发酵基础。'],['英语','完形/新题型入门；小作文 1 篇。'],['政治','毛中特开篇；选择题日更。']]],
  ['W4｜9/1–9/7',[['生化','氨基酸代谢、尿素循环。'],['分子','表达调控（操纵子/增强子/沉默子）。'],['微生','细菌遗传（接合/转导/转化）。'],['英语','阅读 6 篇；语法错题清单 v1。'],['政治','史纲 1 章；周测（专业课 40–60 题）。']]],
  ['W5｜9/8–9/14',[['生化','核苷酸代谢；嘌呤嘧啶异常。'],['分子','分子技术 I（PCR/电泳）。'],['微生','抗菌药物机制与耐药性概览。'],['英语','翻译训练 3 段；大作文 1 篇。'],['政治','毛中特 2 章。']]],
  ['W6｜9/15–9/21',[['生化','维生素与辅酶；信号转导基础。'],['分子','分子技术 II（克隆/载体/Blot/测序）。'],['微生','病毒学入门（结构/复制）。'],['英语','阅读 6 篇；词汇二轮。'],['政治','史纲 2 章；本月综合小测。']]],
  ['W7｜9/22–9/28',[['生化','整合代谢（肝/脂肪/肌肉调控）。'],['分子','表观遗传（甲基化/组蛋白修饰）。'],['微生','免疫基础（与微生相关）。'],['英语','写作模板完善；完形巩固。'],['政治','思修与法基开篇。']]],
  ['W8｜9/29–10/5',[['通用','串讲周 I：三科交叉梳理；制作易混清单。'],['英语','真题年份1：阅读精做+复盘。'],['政治','选择题连做（每日 40 题）；错题归档。']]],
  ['W9｜10/6–10/12',[['专业课','真题一轮：代谢/分子基础类专题整组刷题。'],['英语','真题年份2；翻译/新题型穿插。'],['政治','毛中特+史纲穿插；周末整卷（选择）。']]],
  ['W10｜10/13–10/19',[['专业课','真题一轮：微生/病毒/免疫相关专题。'],['英语','真题年份3；作文仿写 2 篇。'],['政治','思修法基进度；每日 40–60 选择。']]],
  ['W11｜10/20–10/26',[['专业课','真题一轮收尾 + 错题回灌；建立索引表。'],['英语','真题年份4；词汇盲点清除。'],['政治','形势与政策开篇；本月综合卷 1 套。']]],
  ['W12｜10/27–11/2',[['专业课','真题二轮启动：按错因分类（概念/易混/计算/实验）。'],['英语','真题年份5；作文素材库 v2。'],['政治','选择题巩固；主观题框架初建。']]],
  ['W13｜11/3–11/9',[['专业课','模拟卷 I（每周 1–2 套）+ 二轮错题。'],['英语','真题年份6；大作文每两天 1 篇。'],['政治','主观题框架二次迭代。']]],
  ['W14｜11/10–11/16',[['专业课','模拟卷 II + 二轮错题闭环；背诵开始日更。'],['英语','真题年份7；翻译专项。'],['政治','整卷 1 套。']]],
  ['W15｜11/17–11/23',[['专业课','模拟卷 III；速记册第二版完成。'],['英语','真题年份8；作文押题素材整理。'],['政治','选择题密集 + 大题框架默写。']]],
  ['W16｜11/24–11/30',[['专业课','模拟卷 IV；第三轮错题（仅高频）。'],['英语','真题查漏补缺；作文模板最终版。'],['政治','整卷 1–2 套；错题清空。']]],
  ['W17｜12/1–12/7',[['专业课','冲刺：背诵+小型套题（隔日 1 套）。'],['英语','作文押题演练（隔日 1 篇）。'],['政治','大题密集背诵（每日 2–3 题）。']]],
  ['W18｜12/8–12/14',[['专业课','冲刺：高频清单反复；模拟卷速度与准确性微调。'],['英语','写作+翻译提速。'],['政治','整卷 2 套；主观题再背一轮。']]],
  ['W19｜12/15–12/20（考前周）',[['通用','12/15–17：轻量背诵+手感维持；12/18–19：仅背诵与例题回看；12/20：考试流程卡。']]],
];

// 第 1 周每日示范
const dayExamples = {
  '2025-08-12': [
    ['生化','酶学基础：酶动力学、影响因素、别构调节（例题 10 题）'],
    ['分子','DNA 结构与复制总览（绘制流程图）'],
    ['微生','形态结构与染色法总览'],
    ['英语','长难句 6 条；阅读 1 篇（标注逻辑词）'],
    ['政治','马原绪论 1.5h（概念卡）'],
    ['通用','错题本开设 + 知识树 v1'],
  ],
  '2025-08-13': [
    ['生化','糖代谢：糖酵解（关键酶、ATP 收支）'],
    ['分子','复制起始与延伸（原核 vs 真核）'],
    ['微生','无菌操作与灭菌方法'],
    ['英语','词汇复习 + 阅读 1 篇'],
    ['政治','选择题 40 题（马原）'],
    ['通用','代谢图补全（糖酵解）'],
  ],
  '2025-08-14': [
    ['生化','糖异生与糖原代谢（激素调控）'],
    ['分子','复制校对与修复（错配/切除修复）'],
    ['微生','细菌生长曲线与培养条件'],
    ['英语','完形基础 20 题；长难句 6 条'],
    ['政治','马原第一章精讲'],
    ['通用','错题归类（概念混淆区）'],
  ],
  '2025-08-15': [
    ['生化','磷酸戊糖途径（NADPH、核糖-5-P）'],
    ['分子','转录入门（RNA 聚合酶、启动子）'],
    ['微生','消毒剂分类与应用'],
    ['英语','阅读 1 篇（做→精读→改错）'],
    ['政治','选择题 40 题'],
    ['通用','周清单更新'],
  ],
  '2025-08-16': [
    ['生化','糖代谢小结（综合题 10–20）'],
    ['分子','转录调控：σ 因子 / 增强子 / 沉默子'],
    ['微生','案例题 10 题'],
    ['英语','小作文 1 篇（自评清单）'],
    ['政治','马原知识卡整理'],
    ['通用','本周错题再做一遍'],
  ],
  '2025-08-17': [
    ['通用','机动/半休：补缺 + 回看笔记；运动加长；排好下周计划'],
  ],
};

// ====== 简易工具 ======
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => n.toString().padStart(2,'0');
const toISODate = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);

function weekIndexFromDate(date){
  const ms = date - START_DATE;
  const idx = Math.floor(ms / (1000*60*60*24*7));
  return Math.max(0, Math.min(weekPlan.length-1, idx));
}
function getToday(){ return new Date(); }

// ====== 头部与倒计时 ======
function renderHeader(){
  const now = new Date();
  const weekDay = ['周日','周一','周二','周三','周四','周五','周六'][now.getDay()];
  const daysLeft = Math.ceil((EXAM_DATE - now)/(1000*60*60*24));
  $('#todayLine').textContent = `今天：${toISODate(now)}（${weekDay}） · 距考试 ${daysLeft} 天 · 计划包含：三层结构（月/周/日）+ 固定时间表`;
  $('#examDateText').textContent = toISODate(EXAM_DATE);
}
let countCollapsed=false;
function startCountdown(){
  function tick(){
    const now = new Date();
    const diff = EXAM_DATE - now;
    const d = Math.max(0, Math.floor(diff/(1000*60*60*24)));
    const h = Math.max(0, Math.floor(diff/(1000*60*60)) % 24);
    const m = Math.max(0, Math.floor(diff/(1000*60)) % 60);
    const s = Math.max(0, Math.floor(diff/1000) % 60);
    $('#d').textContent = d; $('#h').textContent = fmt(h); $('#m').textContent = fmt(m); $('#s').textContent = fmt(s);
  }
  tick(); setInterval(tick, 1000);
  $('#countCard').addEventListener('click', ()=>{
    countCollapsed=!countCollapsed; $('.timer').style.display = countCollapsed?'none':'flex';
  });
}

// ====== 周计划渲染（折叠列表） ======
function renderWeek(){
  const box = $('#weekContainer'); box.innerHTML='';
  weekPlan.forEach((wk, i)=>{
    const d = document.createElement('details'); d.dataset.week = i+1; d.open = (i===0);
    const [title, items] = wk;
    d.innerHTML = `<summary><div class="ttl"><span class="wk">${'W'+(i+1)}</span><b>${title}</b></div></summary>`;
    const ul = document.createElement('ul'); ul.className='tasks';
    items.forEach(([sub,txt])=>{
      const li = document.createElement('li');
      li.dataset.subject=sub; li.innerHTML = `<span class="tag">${sub}</span>${txt}`;
      ul.appendChild(li);
    });
    d.appendChild(ul); box.appendChild(d);
  });
}

// ====== 日计划：清单存取 ======
function storageKey(dateStr){ return `gf-plan-${dateStr}`; }
function saveDay(dateStr, items){ localStorage.setItem(storageKey(dateStr), JSON.stringify(items)); }
function loadDay(dateStr){ const s = localStorage.getItem(storageKey(dateStr)); return s? JSON.parse(s): null; }

function defaultItemsFor(dateStr){
  if(dayExamples[dateStr]) return dayExamples[dateStr].map(([sub,txt])=>({sub,text:txt,done:false,custom:false}));
  const d = new Date(dateStr);
  const wIdx = weekIndexFromDate(d);
  const week = weekPlan[wIdx];
  const items = [];
  if(week){ week[1].forEach(([sub,txt])=> items.push({sub,text:`【本周要点】${txt}`,done:false,custom:false})); }
  const daily = [
    ['英语','阅读/翻译/作文 三选一 + 单词复习'],
    ['政治','选择题 40–60；1 段主观题框架'],
    ['通用','错题→原因→改法；速记册更新'],
    ['通用','运动 15:30–16:30（固定）']
  ];
  daily.forEach(([sub,txt])=> items.push({sub,text:txt,done:false,custom:false}));
  return items;
}

// ====== 作息（Schedule）存取与渲染 ======
const DEFAULT_SCHEDULE = [
  {time:'07:00', text:'起床 & 洗漱'},
  {time:'07:20–08:00', text:'英语晨读（单词 + 长难句）'},
  {time:'08:10–10:10', text:'专业课A（生化/真题）'},
  {time:'10:25–12:00', text:'专业课B（分子/技术题）'},
  {time:'12:00–14:00', text:'午餐 + 午休（20–30min）'},
  {time:'14:00–15:20', text:'政治（精讲/选择题）'},
  {time:'15:30–16:30', text:'运动/拉伸（固定锻炼时间）'},
  {time:'16:45–18:15', text:'专业课C（微生/真题）'},
  {time:'19:30–20:30', text:'英语二（阅读/翻译/作文交替）'},
  {time:'20:35–21:35', text:'专项复盘（错题本 + 速记册 + 背诵）'},
  {time:'21:35–22:00', text:'收尾：制定明日三件最重要的事'}
];
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function defaultSchedule(){ return deepClone(DEFAULT_SCHEDULE); }
function schedKey(dateStr){ return `gf-sched-${dateStr}`; }
function saveSchedule(dateStr, arr){ localStorage.setItem(schedKey(dateStr), JSON.stringify(arr)); }
function loadSchedule(dateStr){ const s = localStorage.getItem(schedKey(dateStr)); return s? JSON.parse(s): null; }
function renderSchedule(date){
  const dateStr = toISODate(date);
  let arr = loadSchedule(dateStr);
  if(!arr){ arr = defaultSchedule(); saveSchedule(dateStr, arr); }
  const list = document.getElementById('schedList'); if(!list) return; list.innerHTML='';

  const rerender = ()=> renderSchedule(date);

  arr.forEach((it, idx)=>{
    const li = document.createElement('li'); li.className='sched-item';
    li.innerHTML = `
      <input class="t" type="text" value="${(it.time||'').replace(/"/g,'&quot;')}" />
      <input class="txt" type="text" value="${(it.text||'').replace(/"/g,'&quot;')}" />
      <button class="btn up">↑</button>
      <button class="btn down">↓</button>
      <button class="btn del">删</button>`;
    const t = li.querySelector('.t'); const txt = li.querySelector('.txt');
    const up = li.querySelector('.up'); const down = li.querySelector('.down'); const del = li.querySelector('.del');
    t.addEventListener('change', ()=>{ arr[idx].time = t.value; saveSchedule(dateStr, arr); });
    txt.addEventListener('change', ()=>{ arr[idx].text = txt.value; saveSchedule(dateStr, arr); });
    up.addEventListener('click', ()=>{ if(idx>0){ const x=arr[idx]; arr.splice(idx,1); arr.splice(idx-1,0,x); saveSchedule(dateStr, arr); rerender(); }});
    down.addEventListener('click', ()=>{ if(idx<arr.length-1){ const x=arr[idx]; arr.splice(idx,1); arr.splice(idx+1,0,x); saveSchedule(dateStr, arr); rerender(); }});
    del.addEventListener('click', ()=>{ arr.splice(idx,1); saveSchedule(dateStr, arr); rerender(); });
    list.appendChild(li);
  });

  // 控件
  const addBtn = document.getElementById('schedAdd');
  const resetBtn = document.getElementById('schedReset');
  const copyBtn = document.getElementById('schedCopyPrev');
  if(addBtn){ addBtn.onclick = ()=>{ arr.push({time:'',text:''}); saveSchedule(dateStr, arr); rerender(); }; }
  if(resetBtn){ resetBtn.onclick = ()=>{ arr = defaultSchedule(); saveSchedule(dateStr, arr); rerender(); }; }
  if(copyBtn){ copyBtn.onclick = ()=>{ const y=new Date(date); y.setDate(y.getDate()-1); const src = loadSchedule(toISODate(y)) || defaultSchedule(); saveSchedule(dateStr, deepClone(src)); rerender(); }; }
}

// ====== 日计划渲染（分科目卡片） ======
function renderDay(date){
  const dateStr = toISODate(date);
  $('#dayTitle').textContent = dateStr;
  const key = storageKey(dateStr);
  let items = loadDay(dateStr);
  if(!items){ items = defaultItemsFor(dateStr); saveDay(dateStr, items); }

  // 分组
  const groups = {};
  items.forEach((it, idx)=>{ const sub = it.sub || '自定义'; (groups[sub] ||= []).push({...it, _idx: idx}); });
  const order = ['生化','分子','微生','英语','政治','通用','自定义'];
  const subjects = [...order, ...Object.keys(groups).filter(s=>!order.includes(s)).sort()].filter(s=>groups[s]);

  const box = $('#subjectCards'); box.innerHTML='';
  subjects.forEach(sub=>{
    const arr = groups[sub];
    const done = arr.filter(x=>x.done).length; const total = arr.length;
    const d = document.createElement('details'); d.className='subject-card'; d.open=true;
    d.innerHTML = `<summary class="sub-summary"><span class="tag">${sub}</span><span class="sub-progress">${done}/${total} 已完成</span></summary>`;
    const wrap = document.createElement('div'); wrap.className='sub-items';

    arr.forEach(obj=>{
      const line = document.createElement('div'); line.className='item';
      line.innerHTML = `
        <input type="checkbox" ${obj.done? 'checked':''} style="transform:scale(1.1)" />
        <input type="text" value="${obj.text.replace(/"/g,'&quot;')}" />
        <button class="btn del">删除</button>`;
      const [cb, txt, del] = line.children;
      cb.addEventListener('change', ()=>{ items[obj._idx].done = cb.checked; saveDay(dateStr, items); renderDay(date); });
      txt.addEventListener('change', ()=>{ items[obj._idx].text = txt.value.trim(); saveDay(dateStr, items); });
      del.addEventListener('click', ()=>{ items.splice(obj._idx,1); saveDay(dateStr, items); renderDay(date); });
      wrap.appendChild(line);
    });

    const add = document.createElement('div'); add.className='addline';
    add.innerHTML = `<input type="text" placeholder="为『${sub}』添加任务" /><button class="btn">添加</button>`;
    const [ipt, btn] = add.children;
    btn.addEventListener('click', ()=>{ const v = ipt.value.trim(); if(!v) return; ipt.value=''; items.push({sub, text:v, done:false, custom:true}); saveDay(dateStr, items); renderDay(date); });

    d.appendChild(wrap); d.appendChild(add); box.appendChild(d);
  });

  // 自检信息
  const wIdx = weekIndexFromDate(date);
  $('#selfCheck').textContent = `当前周次：W${wIdx+1}（${weekPlan[wIdx][0]}），本日键名：${key}`;

  // 渲染作息
  renderSchedule(date);
}

// ====== 月历打卡视图 ======
function getItems(dateStr, opts={preview:false}){
  let items = loadDay(dateStr);
  if(!items){ items = defaultItemsFor(dateStr); if(!opts.preview) saveDay(dateStr, items); }
  return items;
}
function renderMonthCalendar(refDate){
  const base = refDate? new Date(refDate): new Date($('#datePick').value+'T00:00:00');
  if(isNaN(base)) return;
  const y = base.getFullYear(), m = base.getMonth();
  const first = new Date(y, m, 1);
  const w = (first.getDay()+6)%7; // 周一为起点
  const start = new Date(y, m, 1 - w);
  const grid = $('#calGrid'); grid.innerHTML='';
  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const iso = toISODate(d);
    const inMonth = d.getMonth()===m;
    const cell = document.createElement('div'); cell.className='cal-cell'+(inMonth?'':' out');
    cell.innerHTML = `<div class="date">${d.getDate()}</div>`;
    let items=null; if(d>=START_DATE && d<=EXAM_DATE){ items = getItems(iso, {preview:true}); }
    const stat = document.createElement('div'); stat.className='stat';
    if(items){
      const total = items.length; const done = items.filter(x=>x.done).length; const pct = total? Math.round(done*100/total) : 0;
      stat.textContent = `完成 ${done}/${total} (${pct}%)`;
      cell.addEventListener('click', ()=>{
        $('#datePick').value = iso; renderDay(d);
        $$('.tab').forEach(x=>x.classList.remove('active')); document.querySelector('.tab[data-tab="day"]').classList.add('active');
        $$('.view').forEach(v=>v.classList.remove('active')); $('#view-day').classList.add('active');
        window.scrollTo({top:0, behavior:'smooth'});
      });
    }else{ stat.textContent = '—'; }
    cell.appendChild(stat); grid.appendChild(cell);
  }
  const mp = $('#monthPick'); if(mp){ mp.value = `${y}-${fmt(m+1)}`; }
}

// ====== Tab 与控件 ======
function setupTabs(){
  $$('.tab').forEach(t=> t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name = t.dataset.tab;
    $$('.view').forEach(v=> v.classList.remove('active'));
    $('#view-'+name).classList.add('active');
  }));
}

function setupControls(){
  $('#subjectFilter').addEventListener('change', applyFilters);
  $('#searchBox').addEventListener('input', applyFilters);

  const today = getToday();
  $('#datePick').value = toISODate(today);
  $('#datePick').addEventListener('change', e=>{ const d = new Date(e.target.value+'T00:00:00'); renderDay(d); renderMonthCalendar(d); });

  $('#expandWeek').addEventListener('click', ()=>{
    const d = new Date($('#datePick').value+'T00:00:00');
    const idx = weekIndexFromDate(d) + 1;
    const cards = $$(`#weekContainer details[data-week]`);
    let target = cards.find(c=> Number(c.dataset.week)===idx);
    if(target){ target.open = !target.open; target.scrollIntoView({behavior:'smooth', block:'center'}); }
  });

  $('#clearAll').addEventListener('click', ()=>{
    if(!confirm('确定要清除本页面的所有日计划勾选与自定义记录吗？（不可恢复）')) return;
    Object.keys(localStorage).filter(k=>k.startsWith('gf-plan-')||k.startsWith('gf-sched-')).forEach(k=> localStorage.removeItem(k));
    const d = new Date($('#datePick').value+'T00:00:00');
    renderDay(d); renderMonthCalendar(d);
    alert('已清除。');
  });

  const cur = new Date($('#datePick').value+'T00:00:00');
  $('#monthPick').value = `${cur.getFullYear()}-${fmt(cur.getMonth()+1)}`;
  $('#monthPick').addEventListener('change', e=>{ const d = new Date(e.target.value+'-01T00:00:00'); renderMonthCalendar(d); });
  $('#prevMonth').addEventListener('click', ()=>{ const [yy,mm] = $('#monthPick').value.split('-').map(Number); const d = new Date(yy, mm-2, 1); renderMonthCalendar(d); });
  $('#nextMonth').addEventListener('click', ()=>{ const [yy,mm] = $('#monthPick').value.split('-').map(Number); const d = new Date(yy, mm, 1); renderMonthCalendar(d); });
}

// ====== 过滤器（科目 + 搜索，仅作用于周计划列表） ======
function applyFilters(){
  const sub = $('#subjectFilter').value; const kw = $('#searchBox').value.trim();
  ['#weekContainer'].forEach(sel=>{
    $$(sel+' li').forEach(li=>{
      let show = true; if(sub!=='all' && li.dataset.subject!==sub) show=false;
      if(kw){ const text = li.textContent.toLowerCase(); show = show && text.includes(kw.toLowerCase()); }
      li.style.display = show? 'list-item':'none';
    });
  });
}

// ====== 简易自测（Test Cases） ======
function runTests(){
  const results = []; const ok = (name,cond)=> results.push(`${cond?'✅':'❌'} ${name}`);
  try{ ok('Tabs 数量 ≥ 4', document.querySelectorAll('.tab').length>=4); }catch(e){ ok('Tabs 渲染', false); }
  try{ renderWeek(); ok('周计划渲染（details 数）> 0', document.querySelectorAll('#weekContainer details').length>0); }catch(e){ ok('周计划渲染异常', false); }
  try{ renderMonthCalendar(new Date('2025-08-01')); ok('月历 42 单元格', document.querySelectorAll('#calGrid .cal-cell').length===42); }catch(e){ ok('月历渲染异常', false); }
  try{ renderDay(new Date('2025-08-13')); ok('日计划分组渲染（科目卡）> 0', document.querySelectorAll('#subjectCards details').length>0); }catch(e){ ok('日计划渲染异常', false); }
  try{ const k=storageKey('2099-01-01'); saveDay('2099-01-01',[{sub:'自测',text:'ok',done:false}]); ok('localStorage 可写', !!localStorage.getItem(k)); localStorage.removeItem(k);}catch(e){ ok('localStorage 写入失败', false); }
  try{ ok('默认作息 >= 8 条', DEFAULT_SCHEDULE.length>=8); }catch(e){ ok('默认作息构建', false); }
  try{ const d='2099-02-02'; const arr=[{time:'08:00',text:'测试A'},{time:'09:00',text:'测试B'},{time:'10:00',text:'测试C'}]; saveSchedule(d, arr); const got = loadSchedule(d)||[]; ok('作息保存/读取长度=3', got.length===3); renderSchedule(new Date('2099-02-02')); ok('作息渲染条目=3', document.querySelectorAll('#schedList .sched-item').length===3); }catch(e){ ok('作息编辑流程', false); }
  const info = results.join(' ｜ '); const box = document.getElementById('selfCheck'); if(box) box.textContent = info;
}

// ====== 首次渲染 ======
renderHeader();
startCountdown();
renderWeek();
setupTabs();
setupControls();
renderDay(getToday());
renderMonthCalendar();
applyFilters();
runTests();
</script>
</body>
</html>
