<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>考研学习工作台（带账号存储）</title>
  <meta name="description" content="考研学习工作台：待办、番茄钟、倒计时、打卡日历、词汇卡片、笔记本、周计划、统计、账号存储。"/>
  <style>
    /* ======= 样式：保持原暗色主题 ======= */
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --panel-hi: #16202b;
      --text: #eaeef3;
      --muted: #a8b3c1;
      --brand: #50a7ff;
      --ok: #34d399;
      --warn: #fbbf24;
      --err: #f87171;
    }
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      margin: 0;
    }
    header{
      padding: 10px;
      background: var(--panel);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1{ font-size: 1.2em; margin: 0; }
    .btn{
      background: var(--brand);
      border: none;
      padding: 6px 12px;
      margin: 2px;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .panel{
      background: var(--panel);
      margin: 10px;
      padding: 10px;
      border-radius: 6px;
    }
    canvas{ background: var(--panel-hi); border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <h1>📚 考研学习工作台</h1>
  <div>
    <button class="btn" onclick="userLogin()">登录 / 注册</button>
    <button class="btn" onclick="userLogout()">退出</button>
  </div>
</header>

<div id="main">
  <!-- ====== 各个功能模块 ====== -->
  <div class="panel" id="todo-panel">
    <h2>待办事项</h2>
    <input id="todo-input" placeholder="输入任务后回车"/>
    <ul id="todo-list"></ul>
  </div>

  <div class="panel">
    <h2>统计图</h2>
    <canvas id="stats" width="600" height="300"></canvas>
  </div>

  <!-- 这里可以继续放番茄钟、倒计时、打卡日历、词汇卡片、周计划、笔记本等模块 -->
</div>

<script>
  // ===== 简单的待办逻辑（示例，保持原结构可替换成完整版） =====
  const todoInput = document.getElementById('todo-input');
  const todoList = document.getElementById('todo-list');
  function renderTodos(){
    todoList.innerHTML = '';
    for(let i=0;i<localStorage.length;i++){
      const key = localStorage.key(i);
      if(key.startsWith('todo:')){
        const li = document.createElement('li');
        li.textContent = localStorage.getItem(key);
        todoList.appendChild(li);
      }
    }
  }
  todoInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const val = todoInput.value.trim();
      if(val){
        localStorage.setItem('todo:'+Date.now(), val);
        todoInput.value = '';
        renderTodos();
      }
    }
  });
  renderTodos();

  // ====== 绘制统计图（柱状图示例） ======
  function drawBar(canvasId, data, labelGetter, valueGetter) {
    const cvs = document.getElementById(canvasId);
    if (!cvs) return;
    const ctx = cvs.getContext('2d');
    if (!ctx) return;

    const DPR = window.devicePixelRatio || 1;
    const w = cvs.width / DPR;
    const h0 = cvs.height / DPR;
    const pad = 20 * DPR;
    const innerW = w - pad * 2;
    const innerH = h0 - pad * 2;
    ctx.font = 12 * DPR + 'px ' + getComputedStyle(document.body).fontFamily;

    const max = Math.max(1, ...data.map(valueGetter));
    const n = data.length;
    const barW = innerW / n * 0.72;
    const gap = (innerW / n - barW);

    ctx.clearRect(0, 0, w, h0);
    ctx.globalAlpha = 0.5;
    ctx.fillStyle = '#ccc';
    ctx.fillRect(pad, pad + innerH, innerW, 1);
    ctx.globalAlpha = 1;

    data.forEach((d, i) => {
      const v = valueGetter(d);
      const h = v / max * (innerH - 10 * DPR);
      const x = pad + i * (barW + gap) + gap / 2;
      const y = pad + innerH - h;

      ctx.fillStyle = '#50a7ff';
      ctx.fillRect(x, y, barW, h);

      ctx.fillStyle = '#eaeef3';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillText(v, x + barW / 2, y - 2 * DPR);

      ctx.fillStyle = '#a8b3c1';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(labelGetter(d), x + barW / 2, pad + innerH + 4 * DPR);
    });
  }
  drawBar('stats', [
    {day:'一',val:3},
    {day:'二',val:5},
    {day:'三',val:2}
  ], d=>d.day, d=>d.val);
</script>

<!-- ===== Firebase 登录 + 云同步集成 ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { 
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, signOut 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAV2sDzzYW6qcQ2YCJUQ_IJxeqbAf27Lgs",
    authDomain: "web-1-13c27.firebaseapp.com",
    projectId: "web-1-13c27",
    storageBucket: "web-1-13c27.firebasestorage.app",
    messagingSenderId: "472569141099",
    appId: "1:472569141099:web:a73ca462c677a53824de2e",
    measurementId: "G-DG6YD17SES"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.userLogin = async function(){
    const email = prompt("请输入邮箱：");
    if(!email) return;
    const pwd = prompt("请输入密码：");
    if(!pwd) return;
    try {
      await signInWithEmailAndPassword(auth, email, pwd);
      alert("登录成功！");
    } catch(e) {
      if(e.code === "auth/user-not-found"){
        await createUserWithEmailAndPassword(auth, email, pwd);
        alert("注册成功并已登录！");
      } else {
        alert("登录失败: " + e.message);
      }
    }
  };

  window.userLogout = function(){
    signOut(auth).then(()=>alert("已退出登录"));
  };

  async function syncToCloud(uid){
    const all = {};
    for(let i=0; i<localStorage.length; i++){
      const key = localStorage.key(i);
      all[key] = localStorage.getItem(key);
    }
    await setDoc(doc(db, "users", uid), { data: all });
    console.log("✅ 数据已同步到云端");
  }

  async function loadFromCloud(uid){
    const snap = await getDoc(doc(db, "users", uid));
    if(snap.exists()){
      const all = snap.data().data;
      Object.keys(all).forEach(k=>{
        localStorage.setItem(k, all[k]);
      });
      console.log("⬇ 已从云端加载数据");
    } else {
      console.log("ℹ 云端无数据，首次使用");
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      console.log("已登录:", user.email);
      await loadFromCloud(user.uid);
      setInterval(()=>syncToCloud(user.uid), 30000);
    } else {
      console.log("未登录");
    }
  });
</script>

</body>
</html>
