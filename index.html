<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è€ƒç ”å­¦ä¹ å·¥ä½œå°ï¼ˆå¸¦è´¦å·å­˜å‚¨ï¼‰</title>
  <meta name="description" content="è€ƒç ”å­¦ä¹ å·¥ä½œå°ï¼šå¾…åŠã€ç•ªèŒ„é’Ÿã€å€’è®¡æ—¶ã€æ‰“å¡æ—¥å†ã€è¯æ±‡å¡ç‰‡ã€ç¬”è®°æœ¬ã€å‘¨è®¡åˆ’ã€ç»Ÿè®¡ã€è´¦å·å­˜å‚¨ã€‚"/>
  <style>
    /* ======= æ ·å¼ï¼šä¿æŒåŸæš—è‰²ä¸»é¢˜ ======= */
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --panel-hi: #16202b;
      --text: #eaeef3;
      --muted: #a8b3c1;
      --brand: #50a7ff;
      --ok: #34d399;
      --warn: #fbbf24;
      --err: #f87171;
    }
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      margin: 0;
    }
    header{
      padding: 10px;
      background: var(--panel);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1{ font-size: 1.2em; margin: 0; }
    .btn{
      background: var(--brand);
      border: none;
      padding: 6px 12px;
      margin: 2px;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .panel{
      background: var(--panel);
      margin: 10px;
      padding: 10px;
      border-radius: 6px;
    }
    canvas{ background: var(--panel-hi); border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“š è€ƒç ”å­¦ä¹ å·¥ä½œå°</h1>
  <div>
    <button class="btn" onclick="userLogin()">ç™»å½• / æ³¨å†Œ</button>
    <button class="btn" onclick="userLogout()">é€€å‡º</button>
  </div>
</header>

<div id="main">
  <!-- ====== å„ä¸ªåŠŸèƒ½æ¨¡å— ====== -->
  <div class="panel" id="todo-panel">
    <h2>å¾…åŠäº‹é¡¹</h2>
    <input id="todo-input" placeholder="è¾“å…¥ä»»åŠ¡åå›è½¦"/>
    <ul id="todo-list"></ul>
  </div>

  <div class="panel">
    <h2>ç»Ÿè®¡å›¾</h2>
    <canvas id="stats" width="600" height="300"></canvas>
  </div>

  <!-- è¿™é‡Œå¯ä»¥ç»§ç»­æ”¾ç•ªèŒ„é’Ÿã€å€’è®¡æ—¶ã€æ‰“å¡æ—¥å†ã€è¯æ±‡å¡ç‰‡ã€å‘¨è®¡åˆ’ã€ç¬”è®°æœ¬ç­‰æ¨¡å— -->
</div>

<script>
  // ===== ç®€å•çš„å¾…åŠé€»è¾‘ï¼ˆç¤ºä¾‹ï¼Œä¿æŒåŸç»“æ„å¯æ›¿æ¢æˆå®Œæ•´ç‰ˆï¼‰ =====
  const todoInput = document.getElementById('todo-input');
  const todoList = document.getElementById('todo-list');
  function renderTodos(){
    todoList.innerHTML = '';
    for(let i=0;i<localStorage.length;i++){
      const key = localStorage.key(i);
      if(key.startsWith('todo:')){
        const li = document.createElement('li');
        li.textContent = localStorage.getItem(key);
        todoList.appendChild(li);
      }
    }
  }
  todoInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const val = todoInput.value.trim();
      if(val){
        localStorage.setItem('todo:'+Date.now(), val);
        todoInput.value = '';
        renderTodos();
      }
    }
  });
  renderTodos();

  // ====== ç»˜åˆ¶ç»Ÿè®¡å›¾ï¼ˆæŸ±çŠ¶å›¾ç¤ºä¾‹ï¼‰ ======
  function drawBar(canvasId, data, labelGetter, valueGetter) {
    const cvs = document.getElementById(canvasId);
    if (!cvs) return;
    const ctx = cvs.getContext('2d');
    if (!ctx) return;

    const DPR = window.devicePixelRatio || 1;
    const w = cvs.width / DPR;
    const h0 = cvs.height / DPR;
    const pad = 20 * DPR;
    const innerW = w - pad * 2;
    const innerH = h0 - pad * 2;
    ctx.font = 12 * DPR + 'px ' + getComputedStyle(document.body).fontFamily;

    const max = Math.max(1, ...data.map(valueGetter));
    const n = data.length;
    const barW = innerW / n * 0.72;
    const gap = (innerW / n - barW);

    ctx.clearRect(0, 0, w, h0);
    ctx.globalAlpha = 0.5;
    ctx.fillStyle = '#ccc';
    ctx.fillRect(pad, pad + innerH, innerW, 1);
    ctx.globalAlpha = 1;

    data.forEach((d, i) => {
      const v = valueGetter(d);
      const h = v / max * (innerH - 10 * DPR);
      const x = pad + i * (barW + gap) + gap / 2;
      const y = pad + innerH - h;

      ctx.fillStyle = '#50a7ff';
      ctx.fillRect(x, y, barW, h);

      ctx.fillStyle = '#eaeef3';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillText(v, x + barW / 2, y - 2 * DPR);

      ctx.fillStyle = '#a8b3c1';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(labelGetter(d), x + barW / 2, pad + innerH + 4 * DPR);
    });
  }
  drawBar('stats', [
    {day:'ä¸€',val:3},
    {day:'äºŒ',val:5},
    {day:'ä¸‰',val:2}
  ], d=>d.day, d=>d.val);
</script>

<!-- ===== Firebase ç™»å½• + äº‘åŒæ­¥é›†æˆ ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { 
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, signOut 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAV2sDzzYW6qcQ2YCJUQ_IJxeqbAf27Lgs",
    authDomain: "web-1-13c27.firebaseapp.com",
    projectId: "web-1-13c27",
    storageBucket: "web-1-13c27.firebasestorage.app",
    messagingSenderId: "472569141099",
    appId: "1:472569141099:web:a73ca462c677a53824de2e",
    measurementId: "G-DG6YD17SES"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.userLogin = async function(){
    const email = prompt("è¯·è¾“å…¥é‚®ç®±ï¼š");
    if(!email) return;
    const pwd = prompt("è¯·è¾“å…¥å¯†ç ï¼š");
    if(!pwd) return;
    try {
      await signInWithEmailAndPassword(auth, email, pwd);
      alert("ç™»å½•æˆåŠŸï¼");
    } catch(e) {
      if(e.code === "auth/user-not-found"){
        await createUserWithEmailAndPassword(auth, email, pwd);
        alert("æ³¨å†ŒæˆåŠŸå¹¶å·²ç™»å½•ï¼");
      } else {
        alert("ç™»å½•å¤±è´¥: " + e.message);
      }
    }
  };

  window.userLogout = function(){
    signOut(auth).then(()=>alert("å·²é€€å‡ºç™»å½•"));
  };

  async function syncToCloud(uid){
    const all = {};
    for(let i=0; i<localStorage.length; i++){
      const key = localStorage.key(i);
      all[key] = localStorage.getItem(key);
    }
    await setDoc(doc(db, "users", uid), { data: all });
    console.log("âœ… æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯");
  }

  async function loadFromCloud(uid){
    const snap = await getDoc(doc(db, "users", uid));
    if(snap.exists()){
      const all = snap.data().data;
      Object.keys(all).forEach(k=>{
        localStorage.setItem(k, all[k]);
      });
      console.log("â¬‡ å·²ä»äº‘ç«¯åŠ è½½æ•°æ®");
    } else {
      console.log("â„¹ äº‘ç«¯æ— æ•°æ®ï¼Œé¦–æ¬¡ä½¿ç”¨");
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      console.log("å·²ç™»å½•:", user.email);
      await loadFromCloud(user.uid);
      setInterval(()=>syncToCloud(user.uid), 30000);
    } else {
      console.log("æœªç™»å½•");
    }
  });
</script>

</body>
</html>
