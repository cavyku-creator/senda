<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>考研学习 · 登录 + 每日打卡 + 任务清单 + 日历</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* 轻量细节样式 */
  .dot { width:8px;height:8px;border-radius:9999px;display:inline-block }
  .day-cell { user-select:none }
  .scrollbar-thin::-webkit-scrollbar{ height:8px; width:8px }
  .scrollbar-thin::-webkit-scrollbar-thumb{ background:#c7c7c7; border-radius:8px }
  .scrollbar-thin::-webkit-scrollbar-track{ background:transparent }
  .btn { @apply px-3 py-2 rounded-xl shadow-sm border border-gray-300 hover:shadow transition active:scale-[0.98]; }
  .btn-primary { @apply bg-black text-white border-black; }
  .btn-danger { @apply bg-red-600 text-white border-red-600; }
  .tag { @apply text-xs px-2 py-0.5 rounded-full border border-gray-300; }
  .hidden-el { display:none }
</style>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- 顶栏 -->
<header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <div class="flex items-center gap-2">
      <span class="inline-flex items-center justify-center w-9 h-9 rounded-2xl bg-black text-white font-bold">K</span>
      <h1 class="text-lg font-semibold">考研学习面板</h1>
      <span class="tag">Auth + 云同步 + 日历</span>
    </div>
    <div class="ml-auto flex items-center gap-3">
      <span id="nowText" class="text-sm text-gray-600"></span>
      <div id="onlineBadge" class="tag">在线</div>
      <div id="offlineBadge" class="tag hidden-el">离线（变更已本地暂存）</div>
      <button id="btnExport" class="btn">导出数据</button>
      <div id="userBox" class="hidden-el items-center gap-2">
        <span id="userName" class="text-sm font-medium"></span>
        <button id="btnLogout" class="btn">退出</button>
      </div>
    </div>
  </div>
</header>

<!-- 容器 -->
<main class="max-w-6xl mx-auto px-4 py-6">

  <!-- 未登录：认证区 -->
  <section id="authSection" class="grid md:grid-cols-2 gap-6">
    <div class="p-5 bg-white rounded-2xl border shadow-sm">
      <h2 class="text-xl font-semibold mb-4">登录</h2>
      <form id="loginForm" class="space-y-3">
        <div>
          <label class="text-sm">邮箱</label>
          <input id="loginEmail" type="email" required class="w-full border rounded-xl px-3 py-2" />
        </div>
        <div>
          <label class="text-sm">密码</label>
          <input id="loginPassword" type="password" required class="w-full border rounded-xl px-3 py-2" />
        </div>
        <button class="btn btn-primary w-full">邮箱登录</button>
      </form>
      <div class="my-4 text-center text-sm text-gray-500">或</div>
      <button id="btnGoogle" class="btn w-full">使用 Google 登录</button>
    </div>

    <div class="p-5 bg-white rounded-2xl border shadow-sm">
      <h2 class="text-xl font-semibold mb-4">注册新账户</h2>
      <form id="regForm" class="space-y-3">
        <div>
          <label class="text-sm">昵称（可选）</label>
          <input id="regName" type="text" class="w-full border rounded-xl px-3 py-2" />
        </div>
        <div>
          <label class="text-sm">邮箱</label>
          <input id="regEmail" type="email" required class="w-full border rounded-xl px-3 py-2" />
        </div>
        <div>
          <label class="text-sm">密码</label>
          <input id="regPassword" type="password" required minlength="6" class="w-full border rounded-xl px-3 py-2" />
        </div>
        <button class="btn btn-primary w-full">立即注册并登录</button>
      </form>
    </div>
  </section>

  <!-- 已登录：应用区 -->
  <section id="appSection" class="hidden-el space-y-6">

    <!-- 顶部概览卡片 -->
    <div class="grid md:grid-cols-3 gap-4">
      <div class="p-5 bg-white rounded-2xl border shadow-sm">
        <div class="text-sm text-gray-600">今日打卡</div>
        <div class="mt-2 flex items-end justify-between">
          <div class="text-3xl font-bold" id="todayCheckinText">未打卡</div>
          <button id="btnToggleCheckin" class="btn btn-primary">打卡</button>
        </div>
        <div class="mt-3 text-sm text-gray-500">最近一次：<span id="lastCheckinText">-</span></div>
      </div>

      <div class="p-5 bg-white rounded-2xl border shadow-sm">
        <div class="text-sm text-gray-600">连续天数（Streak）</div>
        <div class="mt-2 text-3xl font-bold" id="streakText">0</div>
        <div class="mt-3 text-sm text-gray-500">总打卡：<span id="totalCheckinText">0</span></div>
      </div>

      <div class="p-5 bg-white rounded-2xl border shadow-sm">
        <div class="text-sm text-gray-600">今日任务完成</div>
        <div class="mt-2 text-3xl font-bold"><span id="doneCount">0</span>/<span id="allCount">0</span></div>
        <div class="mt-3 text-sm text-gray-500">点击下方清单进行勾选</div>
      </div>
    </div>

    <!-- 任务清单（模板 + 每日完成状态） -->
    <div class="grid lg:grid-cols-2 gap-6">
      <div class="p-5 bg-white rounded-2xl border shadow-sm">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">我的任务清单（模板）</h3>
          <div class="flex items-center gap-2">
            <button id="btnAddPresetQuick" class="btn">一键添加常用</button>
            <button id="btnClearCompleted" class="btn">删除已完成任务</button>
          </div>
        </div>
        <form id="taskForm" class="flex gap-2">
          <input id="taskInput" placeholder="如：高数刷题 30min" class="flex-1 border rounded-xl px-3 py-2" />
          <button class="btn btn-primary">新增</button>
        </form>
        <ul id="taskList" class="mt-4 space-y-2 max-h-[380px] overflow-auto scrollbar-thin"></ul>
        <div class="text-xs text-gray-500 mt-2">说明：左侧复选框只代表“今天”的完成情况；任务名称为模板，次日勾选会自动重置。</div>
      </div>

      <div class="p-5 bg-white rounded-2xl border shadow-sm">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">今日勾选进度（<span id="todayKeyText">-</span>）</h3>
          <div class="flex items-center gap-2">
            <button id="btnMarkAllDone" class="btn">全部设为已完成</button>
            <button id="btnUnmarkAll" class="btn">全部清除</button>
          </div>
        </div>
        <ul id="todayChecklist" class="space-y-2 max-h-[430px] overflow-auto scrollbar-thin"></ul>
      </div>
    </div>

    <!-- 日历视图 -->
    <div class="p-5 bg-white rounded-2xl border shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">打卡日历</h3>
        <div class="flex items-center gap-2">
          <button id="prevMonth" class="btn">上月</button>
          <div id="monthTitle" class="font-medium w-36 text-center"></div>
          <button id="nextMonth" class="btn">下月</button>
        </div>
      </div>
      <div class="grid grid-cols-7 gap-2 text-center text-sm text-gray-600 mb-2">
        <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
      </div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
      <div class="mt-3 text-sm text-gray-600 flex items-center gap-4">
        <span><span class="dot bg-black"></span> 有打卡</span>
        <span><span class="dot bg-gray-400"></span> 今日完成≥1任务</span>
      </div>
      <div id="calendarInfo" class="mt-4 text-sm text-gray-700"></div>
    </div>

  </section>
</main>

<!-- Firebase（v12.1.0） -->
<script type="module">
  // ------------------ Firebase 初始化 ------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
    signInWithEmailAndPassword, signOut, updateProfile,
    GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc,
    updateDoc, deleteDoc, query, orderBy, enableIndexedDbPersistence, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // 你的配置（来自你发的片段）
  const firebaseConfig = {
    apiKey: "AIzaSyAV2sDzzYW6qcQ2YCJUQ_IJxeqbAf27Lgs",
    authDomain: "web-1-13c27.firebaseapp.com",
    projectId: "web-1-13c27",
    // 其他字段（如 storageBucket / appId / measurementId）可选；Auth+Firestore 可直接运行
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  // Firestore 离线缓存
  try { await enableIndexedDbPersistence(db); } catch (e) {
    console.warn("IndexedDB 持久化不可用（可能多标签冲突），已忽略。", e?.message || e);
  }

  // ------------------ 工具函数 ------------------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const todayKey = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const ymd = (d) => d.toISOString().slice(0,10);
  const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  const escapeHTML = (s) => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  // 在线/离线徽章
  const onlineBadge = $("#onlineBadge");
  const offlineBadge = $("#offlineBadge");
  const setOnlineUI = () => { onlineBadge.classList.remove("hidden-el"); offlineBadge.classList.add("hidden-el"); };
  const setOfflineUI = () => { onlineBadge.classList.add("hidden-el"); offlineBadge.classList.remove("hidden-el"); };
  const updateOnline = () => navigator.onLine ? setOnlineUI() : setOfflineUI();
  window.addEventListener("online", updateOnline);
  window.addEventListener("offline", updateOnline);
  updateOnline();

  // 显示时间
  const nowText = $("#nowText");
  setInterval(()=>{ 
    const d=new Date(); 
    nowText.textContent = d.toLocaleString();
  }, 1000);

  // ------------------ 状态缓存 ------------------
  let currentUser = null;
  let tasks = [];                                // 模板任务：[{id,title,createdAt}]
  let checkinSet = new Set();                    // 有打卡的日期集合
  let dailyMap = new Map();                      // 每日任务完成：date => Set(taskId)
  let unsubscribers = [];                        // 监听取消器
  let currentMonth = new Date();                 // 日历当前月份

  const offlineQueueKey = "offlineQueue";
  const pushOffline = (item) => {
    const q = JSON.parse(localStorage.getItem(offlineQueueKey) || "[]");
    q.push(item);
    localStorage.setItem(offlineQueueKey, JSON.stringify(q));
    setOfflineUI();
  };
  const flushOffline = async () => {
    if (!currentUser) return;
    const q = JSON.parse(localStorage.getItem(offlineQueueKey) || "[]");
    if (!q.length) return;
    for (const it of q) {
      try {
        if (it.t === "checkin") { await _toggleCheckinImpl(it.payload.forceSet); }
        else if (it.t === "addTask") { await _addTaskImpl(it.payload.title, it.payload.id); }
        else if (it.t === "delTask") { await _delTaskImpl(it.payload.id); }
        else if (it.t === "setDone") { await _setTaskDoneForDate(it.payload.date, it.payload.taskId, it.payload.done); }
      } catch (e) {
        console.warn("离线项重放失败，保留以便下次：", it, e?.message||e);
      }
    }
    // 全部尝试后，简单起见清空（失败的会在 UI 操作再次入队）
    localStorage.removeItem(offlineQueueKey);
    updateOnline();
  };

  // ------------------ 认证相关 ------------------
  const authSection = $("#authSection");
  const appSection = $("#appSection");
  const userBox = $("#userBox");
  const userName = $("#userName");

  $("#loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const email = $("#loginEmail").value.trim();
    const pass = $("#loginPassword").value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert("登录失败：" + (err?.message || err));
    }
  });

  $("#regForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const email = $("#regEmail").value.trim();
    const pass = $("#regPassword").value;
    const name = $("#regName").value.trim();
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      if (name) { await updateProfile(cred.user, { displayName: name }); }
    } catch (err) {
      alert("注册失败：" + (err?.message || err));
    }
  });

  $("#btnGoogle").addEventListener("click", async ()=>{
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Google 登录失败：" + (err?.message || err));
    }
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    try { await signOut(auth); } catch {}
  });

  onAuthStateChanged(auth, async (user)=>{
    // 清理旧监听
    unsubscribers.forEach(u=>{ try{u();}catch{} });
    unsubscribers = [];

    currentUser = user || null;
    if (!currentUser) {
      authSection.classList.remove("hidden-el");
      appSection.classList.add("hidden-el");
      userBox.classList.add("hidden-el");
      return;
    }

    // UI
    userName.textContent = currentUser.displayName || currentUser.email || "已登录";
    userBox.classList.remove("hidden-el");
    authSection.classList.add("hidden-el");
    appSection.classList.remove("hidden-el");

    // 初始化数据监听
    await initDataListeners();
    await flushOffline();
  });

  // ------------------ 数据监听 & 同步 ------------------
  async function initDataListeners(){
    tasks = [];
    checkinSet = new Set();
    dailyMap = new Map();

    // 任务模板
    const tasksCol = collection(db, "users", currentUser.uid, "tasks");
    const unsubTasks = onSnapshot(query(tasksCol, orderBy("createdAt","asc")), (snap)=>{
      tasks = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
      renderTasks();
      renderTodayChecklist();
      renderCalendar();
    });
    unsubscribers.push(unsubTasks);

    // 打卡集合（所有日期）
    const checkinsCol = collection(db, "users", currentUser.uid, "checkins");
    const unsubCheckins = onSnapshot(checkinsCol, (snap)=>{
      checkinSet = new Set(snap.docs.map(d=> d.id)); // 文档ID即 YYYY-MM-DD
      renderCheckinOverview();
      renderCalendar();
    });
    unsubscribers.push(unsubCheckins);

    // 每日任务完成集合
    const dailyCol = collection(db, "users", currentUser.uid, "dailyCompletions");
    const unsubDaily = onSnapshot(dailyCol, (snap)=>{
      dailyMap = new Map();
      snap.forEach(d=>{
        const data = d.data()||{};
        const k = d.id; // YYYY-MM-DD
        dailyMap.set(k, new Set(data.taskIds||[]));
      });
      renderTodayChecklist();
      renderOverviewDoneCount();
      renderCalendar();
    });
    unsubscribers.push(unsubDaily);

    // 初始渲染
    renderOverviewDoneCount();
    renderCheckinOverview();
    renderTasks();
    renderTodayChecklist();
    renderCalendar();
  }

  // ------------------ 打卡 ------------------
  const btnToggleCheckin = $("#btnToggleCheckin");
  btnToggleCheckin.addEventListener("click", async ()=>{
    const has = checkinSet.has(todayKey());
    try {
      await _toggleCheckinImpl(!has); // forceSet: true=打卡, false=取消
    } catch (e) {
      pushOffline({ t:"checkin", payload:{ forceSet: !has } });
      // 立即更新本地视图
      if (has) checkinSet.delete(todayKey()); else checkinSet.add(todayKey());
      renderCheckinOverview(); renderCalendar();
    }
  });

  async function _toggleCheckinImpl(forceSet){
    const dref = doc(db, "users", currentUser.uid, "checkins", todayKey());
    if (forceSet) {
      await setDoc(dref, { date: todayKey(), ts: serverTimestamp() }, { merge:true });
    } else {
      // 取消当天打卡即删除文档
      await deleteDoc(dref);
    }
  }

  function renderCheckinOverview(){
    const today = todayKey();
    $("#todayCheckinText").textContent = checkinSet.has(today) ? "已打卡" : "未打卡";
    $("#btnToggleCheckin").textContent = checkinSet.has(today) ? "撤销今日打卡" : "打卡";

    const dates = Array.from(checkinSet).sort(); // 升序
    $("#totalCheckinText").textContent = dates.length;

    // 最近一次
    $("#lastCheckinText").textContent = dates.length ? dates[dates.length-1] : "-";

    // streak
    const s = calcStreak(checkinSet);
    $("#streakText").textContent = s;
  }

  function calcStreak(set){
    let cnt = 0;
    let d = new Date();
    const has = (key)=> set.has(key);
    while (true){
      const key = ymd(d);
      if (has(key)) { cnt++; d.setDate(d.getDate()-1); }
      else break;
    }
    return cnt;
  }

  // ------------------ 任务（模板） ------------------
  const taskList = $("#taskList");
  $("#taskForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const raw = $("#taskInput").value.trim();
    if (!raw) return;
    try {
      await _addTaskImpl(raw);
      $("#taskInput").value = "";
    } catch (e) {
      // 离线：先生成临时ID以便 UI 可见
      const tempId = "tmp_" + Math.random().toString(36).slice(2);
      tasks.push({ id: tempId, title: raw, createdAt: Date.now() });
      renderTasks(); renderTodayChecklist();
      pushOffline({ t:"addTask", payload:{ title: raw, id: tempId } });
      $("#taskInput").value = "";
    }
  });

  async function _addTaskImpl(title, forceId){
    title = title.slice(0, 100);
    if (!title) return;
    if (forceId && forceId.startsWith("tmp_")) {
      // 兼容离线重放：真正写库时忽略临时ID
    }
    await addDoc(collection(db, "users", currentUser.uid, "tasks"), {
      title, createdAt: Date.now()
    });
  }

  async function _delTaskImpl(id){
    await deleteDoc(doc(db, "users", currentUser.uid, "tasks", id));
    // 同时从每日完成里清掉这个 taskId
    const k = todayKey();
    await _setTaskDoneForDate(k, id, false);
  }

  function renderTasks(){
    taskList.innerHTML = "";
    tasks.forEach(t=>{
      const li = document.createElement("li");
      li.className = "flex items-center justify-between gap-2 p-2 border rounded-xl";
      li.innerHTML = `
        <div class="flex-1 truncate">${escapeHTML(t.title)}</div>
        <div class="flex items-center gap-2">
          <button data-id="${t.id}" class="btn text-sm">重命名</button>
          <button data-id="${t.id}" class="btn btn-danger text-sm">删除</button>
        </div>
      `;
      taskList.appendChild(li);
    });

    // 事件
    taskList.querySelectorAll("button.btn-danger").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        if (!confirm("确定删除该任务模板？")) return;
        try { await _delTaskImpl(id); }
        catch (e) { pushOffline({ t:"delTask", payload:{ id } }); }
      });
    });
    taskList.querySelectorAll("button.btn:not(.btn-danger)").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const t = tasks.find(x=>x.id===id);
        const nv = prompt("输入新名称：", t?.title || "");
        if (nv==null) return;
        const title = nv.trim().slice(0,100);
        if (!title) return;
        try {
          await updateDoc(doc(db,"users",currentUser.uid,"tasks",id),{ title });
        } catch (e) {
          alert("重命名失败（请在线后重试）");
        }
      });
    });
    renderOverviewDoneCount();
  }

  // 一键添加常用
  $("#btnAddPresetQuick").addEventListener("click", async ()=>{
    const presets = ["高数刷题 30min","英语阅读 2篇","长难句10句","政治刷题 30min","信号与系统 40min","数字电路 40min","错题整理 20min","背单词 50个"];
    for (const p of presets) {
      try { await _addTaskImpl(p); }
      catch { pushOffline({ t:"addTask", payload:{ title:p, id:"tmp_"+Math.random().toString(36).slice(2) } }); }
      await sleep(60);
    }
  });

  // 删除今日已完成的模板（清理视图用）
  $("#btnClearCompleted").addEventListener("click", async ()=>{
    const today = todayKey();
    const set = dailyMap.get(today) || new Set();
    const ids = Array.from(set);
    if (!ids.length) return alert("今天没有已完成的任务。");
    if (!confirm("确定删除这些【模板任务】吗？注意：这是删除模板，而非仅清除今日勾选。")) return;
    for (const id of ids) {
      try { await _delTaskImpl(id); }
      catch { pushOffline({ t:"delTask", payload:{ id } }); }
      await sleep(40);
    }
  });

  // ------------------ 今日勾选区（每日完成） ------------------
  const todayChecklist = $("#todayChecklist");
  const todayKeyText = $("#todayKeyText");
  todayKeyText.textContent = todayKey();

  function renderTodayChecklist(){
    const dateKey = todayKey();
    todayKeyText.textContent = dateKey;
    const doneSet = dailyMap.get(dateKey) || new Set();

    todayChecklist.innerHTML = "";
    tasks.forEach(t=>{
      const li = document.createElement("li");
      li.className = "flex items-center justify-between gap-2 p-2 border rounded-xl";
      const checked = doneSet.has(t.id);
      li.innerHTML = `
        <label class="flex items-center gap-3 flex-1">
          <input type="checkbox" data-id="${t.id}" ${checked?"checked":""} class="w-4 h-4" />
          <span class="${checked?"line-through text-gray-400":""}">${escapeHTML(t.title)}</span>
        </label>
        <span class="tag">${checked?"已完成":"待完成"}</span>
      `;
      todayChecklist.appendChild(li);
    });

    todayChecklist.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", async ()=>{
        const id = cb.getAttribute("data-id");
        const done = cb.checked;
        try { await _setTaskDoneForDate(todayKey(), id, done); }
        catch {
          // 本地先行
          const set = dailyMap.get(todayKey()) || new Set();
          if (done) set.add(id); else set.delete(id);
          dailyMap.set(todayKey(), set);
          renderTodayChecklist(); renderOverviewDoneCount(); renderCalendar();
          pushOffline({ t:"setDone", payload:{ date: todayKey(), taskId:id, done } });
        }
      });
    });

    renderOverviewDoneCount();
  }

  async function _setTaskDoneForDate(dateKey, taskId, done){
    const dref = doc(db, "users", currentUser.uid, "dailyCompletions", dateKey);
    const snap = await getDoc(dref);
    const cur = new Set((snap.exists() ? (snap.data().taskIds||[]) : []));
    if (done) cur.add(taskId); else cur.delete(taskId);
    await setDoc(dref, { taskIds: Array.from(cur), date: dateKey, ts: serverTimestamp() }, { merge: true });
  }

  function renderOverviewDoneCount(){
    const k = todayKey();
    const doneSet = dailyMap.get(k) || new Set();
    $("#doneCount").textContent = doneSet.size;
    $("#allCount").textContent = tasks.length;
  }

  $("#btnMarkAllDone").addEventListener("click", async ()=>{
    const k = todayKey();
    for (const t of tasks) {
      try { await _setTaskDoneForDate(k, t.id, true); }
      catch { pushOffline({ t:"setDone", payload:{ date:k, taskId:t.id, done:true } }); }
      await sleep(20);
    }
  });
  $("#btnUnmarkAll").addEventListener("click", async ()=>{
    const k = todayKey();
    for (const t of tasks) {
      try { await _setTaskDoneForDate(k, t.id, false); }
      catch { pushOffline({ t:"setDone", payload:{ date:k, taskId:t.id, done:false } }); }
      await sleep(20);
    }
  });

  // ------------------ 日历 ------------------
  const calendarGrid = $("#calendarGrid");
  const monthTitle = $("#monthTitle");
  $("#prevMonth").addEventListener("click", ()=>{ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); });
  $("#nextMonth").addEventListener("click", ()=>{ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); });

  function renderCalendar(){
    // 标题
    monthTitle.textContent = `${currentMonth.getFullYear()}年 ${String(currentMonth.getMonth()+1).padStart(2,"0")}月`;

    // 计算网格
    const first = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const startOffset = (first.getDay()+6)%7; // 周一为首
    const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0).getDate();

    calendarGrid.innerHTML = "";
    for (let i=0;i<startOffset;i++){
      const div = document.createElement("div");
      div.className = "h-16 rounded-xl bg-gray-100/50";
      calendarGrid.appendChild(div);
    }
    for (let d=1; d<=daysInMonth; d++){
      const dateObj = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d);
      const key = fmt(dateObj);
      const hasCheckin = checkinSet.has(key);
      const doneSet = dailyMap.get(key) || new Set();
      const hasAnyDone = doneSet.size>0;
      const isToday = key === todayKey();

      const cell = document.createElement("button");
      cell.className = "day-cell h-16 rounded-xl border bg-white hover:shadow flex flex-col items-center justify-center gap-1";
      cell.innerHTML = `
        <div class="text-sm ${isToday?'font-semibold':''}">${d}</div>
        <div class="flex items-center gap-1">
          <span class="dot ${hasCheckin?'bg-black':'bg-gray-200'}" title="打卡"></span>
          <span class="dot ${hasAnyDone?'bg-gray-500':'bg-gray-200'}" title="完成任务≥1"></span>
        </div>
      `;
      cell.addEventListener("click", ()=>{
        const lines = [];
        lines.push(`日期：${key}`);
        lines.push(`打卡：${hasCheckin?'是':'否'}`);
        lines.push(`完成任务：${doneSet.size} 项`);
        if (doneSet.size) {
          const names = tasks.filter(t=>doneSet.has(t.id)).map(t=>`· ${t.title}`);
          if (names.length) lines.push(names.join("\n"));
        }
        $("#calendarInfo").textContent = lines.join(" | ");
      });

      calendarGrid.appendChild(cell);
    }
  }

  // ------------------ 导出 ------------------
  $("#btnExport").addEventListener("click", ()=>{
    if (!currentUser) return alert("请先登录");
    const data = {
      exportedAt: new Date().toISOString(),
      user: { uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName || "" },
      tasks,
      checkins: Array.from(checkinSet),
      daily: Array.from(dailyMap.entries()).map(([k,set])=>({ date:k, taskIds: Array.from(set) })),
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `study-data-${todayKey()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

</script>

</body>
</html>
