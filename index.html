<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>考研学习工作台 · 生物技术版（单文件 + 云同步）</title>
  <meta name="description" content="单文件考研学习工作台（生物技术）：待办、番茄钟、倒计时、打卡日历、词汇卡片、笔记、统计、阶段周计划、时间规划表、备份/还原、账号云同步。数据本地保存并可同步到云端。" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --panel-hi: #16202b;
      --text: #eaeef3;
      --muted: #a8b3c1;
      --brand: #50a7ff;
      --ok: #34d399;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --gap: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, Helvetica, Arial, sans-serif;
    }
    [data-theme="light"]{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --panel-hi: #f0f3f7;
      --text: #0f1621;
      --muted: #66707b;
      --brand: #2b78ff;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% 0%, rgba(80,167,255,.10), transparent 60%),
      radial-gradient(1000px 600px at 100% 20%, rgba(52,211,153,.10), transparent 60%), var(--bg);
      color:var(--text); font-family:var(--font); line-height:1.5; overflow-y:overlay;
    }
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(130%) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0)), var(--panel);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar{max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:10px; align-items:center}
    .title{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .title .logo{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #34d399); box-shadow:var(--shadow)}
    .grow{flex:1}
    .btn{appearance:none; border:none; padding:9px 12px; border-radius:10px; background:var(--panel-hi); color:var(--text); cursor:pointer; box-shadow:var(--shadow);
      transition:transform .05s ease, background .2s ease, opacity .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.icon{padding:8px; display:inline-grid; place-items:center}
    .btn.primary{background:linear-gradient(135deg, var(--brand), #7cc2ff)}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .btn.danger{background:linear-gradient(135deg, var(--danger), #ff8a8a)}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--panel-hi); font-size:12px; color:var(--muted)}
    main{max-width:1200px; margin:18px auto 40px; padding:0 16px;}
    .grid{display:grid; grid-template-columns: 330px 1fr; gap:var(--gap)}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius-lg); box-shadow:var(--shadow)}
    .panel .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10)}
    .panel .bd{padding:14px}
    .muted{color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .kpi .card{padding:12px; background:var(--panel-hi); border-radius:12px; text-align:center}
    .kpi .num{font-size:22px; font-weight:700}

    .countdown{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .countdown .box{padding:10px; background:var(--panel-hi); border-radius:12px}
    .countdown .big{font-size:28px; font-weight:800}

    .pomodoro{display:grid; gap:10px}
    .pomodoro .screen{display:grid; place-items:center; padding:18px; background:var(--panel-hi); border-radius:12px; font-variant-numeric: tabular-nums;}
    .pomodoro .time{font-size:42px; font-weight:800}
    .pomodoro .modes{display:flex; gap:6px; flex-wrap:wrap; justify-content:center}
    .pomodoro .modes .btn{border-radius:999px; padding:6px 10px}
    .row{display:flex; gap:6px; flex-wrap:wrap; align-items:center}

    .todo-header{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{border-radius:999px; padding:6px 10px; background:var(--panel-hi); cursor:pointer; user-select:none}
    .pill.active{outline:2px solid var(--brand)}
    .todo-inputs{display:grid; grid-template-columns:1.6fr .9fr .9fr .6fr auto; gap:8px; margin-top:10px}
    @media (max-width:900px){.todo-inputs{grid-template-columns:1.5fr .9fr .9fr .7fr}}
    @media (max-width:640px){.todo-inputs{grid-template-columns:1fr}}
    input, select, textarea{width:100%; background:var(--panel-hi); color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px; outline:none}
    input::placeholder, textarea::placeholder{color:rgba(168,179,193,.7)}

    .task{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px dashed rgba(255,255,255,.16); margin-bottom:8px; background:linear-gradient(0deg, rgba(22,32,43,.7), transparent)}
    .task.dragging{opacity:.6}
    .task .title{font-weight:600}
    .task .meta{font-size:12px; color:var(--muted)}
    .task .tag{font-size:12px; padding:3px 8px; border-radius:999px; background:rgba(80,167,255,.20); margin-left:6px}
    .task.done{opacity:.6; text-decoration:line-through}

    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px}
    .day{aspect-ratio:1/1; border-radius:10px; background:var(--panel-hi); display:flex; flex-direction:column; padding:6px; cursor:pointer; position:relative}
    .day .d{font-size:12px; color:var(--muted)}
    .day .dot{width:8px; height:8px; border-radius:50%; position:absolute; right:6px; bottom:6px; background:var(--muted)}
    .day.good .dot{background:var(--ok)}
    .day.bad .dot{background:var(--danger)}
    .dow{font-size:12px; color:var(--muted); text-align:center; margin-bottom:6px}

    .toolbar{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px}
    .editor{min-height:180px; padding:12px; border-radius:12px; background:var(--panel-hi); outline:none}

    .vocab{display:grid; gap:8px}
    .card{border-radius:12px; padding:16px; background:var(--panel-hi); text-align:center}
    .card .word{font-size:26px; font-weight:800}
    .card .mean{margin-top:6px; color:var(--muted)}

    .stats-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){.stats-grid{grid-template-columns:1fr}}
    canvas{width:100%; height:220px}

    .wk-list{margin:0; padding-left:18px}
    .wk-list li{margin:6px 0}
    .tt-row{display:grid; grid-template-columns:120px 1fr; gap:10px; padding:10px; border-radius:12px;
      background:var(--panel-hi); border:1px dashed rgba(255,255,255,.16); margin-bottom:8px}
    .tt-time{font-weight:700; color:var(--muted)}

    @media print{
      header, .no-print{display:none !important}
      body{background:#fff}
      .panel{box-shadow:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title" aria-label="品牌标识与标题">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div>考研学习工作台 · 生物技术</div>
          <div class="muted" style="font-size:12px">本地运行 · 单文件 · 离线可用 · 支持云同步</div>
        </div>
      </div>
      <div class="grow"></div>
      <span id="now" class="badge" aria-live="polite">--:--</span>
      <span id="authStatus" class="badge">未登录</span>
      <button id="loginBtn" class="btn" title="登录/注册">登录/注册</button>
      <button id="logoutBtn" class="btn ghost" title="退出登录" hidden>退出</button>
      <button id="themeBtn" class="btn icon" title="切换明/暗主题" aria-label="切换明暗主题">🌓</button>
      <button id="onboardBtn" class="btn" title="首设向导">初始设置</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="panel" id="leftPanel" aria-label="侧边工作区">
        <div class="hd"><strong>倒计时与番茄钟</strong>
          <div class="row">
            <label class="badge" for="examDate">初试日期</label>
            <input type="date" id="examDate"/>
          </div>
        </div>
        <div class="bd">
          <div class="countdown" aria-label="倒计时区块">
            <div class="box" title="距离初试"><div class="muted">距离初试</div><div class="big" id="dLeft">--</div><div class="muted">天</div></div>
            <div class="box" title="今日目标"><div class="muted">今日目标</div>
              <div class="row" style="align-items:center; margin-top:6px">
                <input type="number" id="goalMin" min="10" step="5" value="180" aria-label="目标分钟数"/>
                <span class="muted">分钟</span>
                <span class="badge" id="goalHit">未达成</span>
              </div>
              <div class="muted" id="todayProgress" style="margin-top:6px">今日专注 0 分钟 · 0 个番茄</div>
            </div>
          </div>

          <div class="pomodoro" aria-label="番茄钟">
            <div class="modes">
              <button class="btn pill" data-mode="work">专注</button>
              <button class="btn pill" data-mode="short">短休</button>
              <button class="btn pill" data-mode="long">长休</button>
              <span class="badge" id="cycleInfo">第 1 轮</span>
            </div>
            <div class="screen">
              <div class="time" id="time">25:00</div>
              <div class="muted" id="modeLabel">专注模式</div>
            </div>
            <div class="row">
              <button class="btn primary" id="startPause">开始</button>
              <button class="btn" id="skip">跳过</button>
              <button class="btn ghost" id="reset">重置</button>
            </div>
            <div class="row">
              <label class="badge">专注/短休/长休(分)</label>
              <input id="cfgWork" type="number" min="5" step="5" value="25" style="width:90px">
              <input id="cfgShort" type="number" min="3" step="1" value="5" style="width:90px">
              <input id="cfgLong" type="number" min="10" step="5" value="15" style="width:90px">
              <label class="badge">每几轮长休</label>
              <input id="cfgEvery" type="number" min="2" step="1" value="4" style="width:90px">
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="kpi" aria-label="关键指标">
            <div class="card"><div class="muted">本周累计(分)</div><div class="num" id="wkMin">0</div></div>
            <div class="card"><div class="muted">本月累计(分)</div><div class="num" id="moMin">0</div></div>
            <div class="card"><div class="muted">连续打卡(天)</div><div class="num" id="streak">0</div></div>
          </div>
        </div>
      </div>

      <div class="panel" id="todoPanel">
        <div class="hd">
          <strong>今日待办</strong>
          <div class="row">
            <span class="badge">按学科筛选</span>
            <div id="filterBar" class="row"></div>
          </div>
        </div>
        <div class="bd">
          <div class="todo-header">
            <div class="muted">建议：为 “英语二 / 政治 / 生化 / 分子生物学 / 微生物” 建立颗粒度适中的任务，估时以 25–50 分为宜。</div>
            <div class="grow"></div>
            <button class="btn" id="tplBtn" title="一键生成模板任务">插入模板</button>
            <button class="btn ghost" id="clearDone">清理已完成</button>
          </div>

          <div class="todo-inputs" style="margin-top:8px" aria-label="新增任务">
            <input id="taskTitle" placeholder="任务内容，如：英语二真题阅读 1 篇 + 精读" aria-label="任务内容"/>
            <select id="taskSubject" aria-label="学科">
              <option value="英语二">英语二</option>
              <option value="政治">政治</option>
              <option value="生化">生化</option>
              <option value="分子生物学">分子生物学</option>
              <option value="微生物">微生物</option>
              <option value="其他">其他</option>
            </select>
            <input id="taskDue" type="date" aria-label="截止日期">
            <select id="taskPri" aria-label="优先级">
              <option value="P2">常规</option>
              <option value="P1">紧急</option>
              <option value="P3">低</option>
            </select>
            <button id="addTask" class="btn primary">添加 (Enter)</button>
          </div>

          <div id="taskList" style="margin-top:10px" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="planPanel">
        <div class="hd">
          <strong>阶段周计划</strong>
          <div class="row">
            <span class="badge" id="phaseLabel">阶段</span>
            <button class="btn icon" id="wkPrev" title="上一周" aria-label="上一周">◀</button>
            <span class="badge" id="wkLabel">第 1 周 · --/-- – --/--</span>
            <button class="btn icon" id="wkNext" title="下一周" aria-label="下一周">▶</button>
            <button class="btn" id="pushWeek" title="把本周计划生成到待办">下发本周到待办</button>
            <button class="btn ghost" id="pushAll" title="一键生成 19 周">一键生成19周</button>
          </div>
        </div>
        <div class="bd">
          <ul id="wkGoals" class="wk-list"></ul>
          <div class="muted" style="margin-top:6px">提示：点击“下发本周到待办”会把本周日常配额生成带截止日期的任务。</div>
        </div>
      </div>

      <div class="panel" id="ttPanel">
        <div class="hd">
          <strong>时间规划表</strong>
          <span class="badge">每日节奏：07:30–22:00</span>
        </div>
        <div class="bd">
          <div id="ttBox" class="tt-grid" aria-label="时间规划表"></div>
          <div class="muted" style="margin-top:6px">说明：此表为默认学习节奏，可在代码里调整。</div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="calendarPanel">
        <div class="hd">
          <strong>打卡日历</strong>
          <div class="row">
            <button class="btn icon" id="prevMonth" title="上月" aria-label="上个月">◀</button>
            <span class="badge" id="ymLabel">--</span>
            <button class="btn icon" id="nextMonth" title="下月" aria-label="下个月">▶</button>
            <span class="badge">标准：当日专注分钟 ≥ 今日目标，视为达标</span>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:6px; justify-content:space-between">
            <div class="row" style="gap:10px">
              <span class="dow">一</span><span class="dow">二</span><span class="dow">三</span>
              <span class="dow">四</span><span class="dow">五</span><span class="dow">六</span><span class="dow">日</span>
            </div>
            <div class="row">
              <button id="markToday" class="btn">手动打卡今天</button>
            </div>
          </div>
          <div id="calendar" class="calendar" aria-label="月历"></div>
        </div>
      </div>

      <div class="panel" id="vocabPanel">
        <div class="hd"><strong>词汇卡片</strong>
          <div class="row">
            <button class="btn" id="startQuiz">开始测验</button>
            <button class="btn ghost" id="shuffle">打乱</button>
          </div>
        </div>
        <div class="bd vocab">
          <div class="row">
            <input id="vWord" placeholder="单词 / 术语 (如: glycolysis)"/>
            <input id="vMean" placeholder="释义 (如: 糖酵解)"/>
            <button id="addVocab" class="btn primary">添加</button>
          </div>
          <div id="vCards" class="row" style="flex-wrap:wrap"></div>
          <div id="quizBox" class="card" hidden>
            <div class="word" id="qFront">—</div>
            <div class="mean" id="qBack" hidden>—</div>
            <div class="row" style="justify-content:center; margin-top:8px">
              <button class="btn" id="reveal">显示释义</button>
              <button class="btn" id="know" title="认识">认识</button>
              <button class="btn" id="dont">不认识</button>
            </div>
            <div class="muted" id="qMeta" style="margin-top:6px">0 / 0</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="notesPanel">
        <div class="hd"><strong>随手笔记</strong>
          <div class="toolbar">
            <button class="btn icon" data-cmd="bold" title="加粗"><b>B</b></button>
            <button class="btn icon" data-cmd="italic" title="斜体"><i>I</i></button>
            <button class="btn icon" data-cmd="underline" title="下划线"><u>U</u></button>
            <button class="btn icon" id="h1Btn" title="一级标题">H1</button>
            <button class="btn" id="clearNotes" title="清空笔记">清空</button>
          </div>
        </div>
        <div class="bd">
          <div id="editor" class="editor" contenteditable="true" aria-label="可编辑笔记区域"></div>
        </div>
      </div>

      <div class="panel" id="statsPanel">
        <div class="hd"><strong>学习统计</strong>
          <div class="row">
            <span class="badge">近 14 天专注分钟</span>
            <span class="badge">完成任务计数</span>
          </div>
        </div>
        <div class="bd stats-grid">
          <canvas id="chartMin" aria-label="专注分钟柱状图"></canvas>
          <canvas id="chartTask" aria-label="完成任务柱状图"></canvas>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="linksPanel">
        <div class="hd"><strong>资料与链接</strong>
          <div class="row">
            <input id="linkTitle" placeholder="名称，如：生化思维导图 PDF" />
            <input id="linkUrl" placeholder="链接，如：https://..." />
            <button id="addLink" class="btn primary">添加</button>
          </div>
        </div>
        <div class="bd" id="links"></div>
      </div>

      <div class="panel no-print" id="toolsPanel">
        <div class="hd"><strong>工具与数据</strong></div>
        <div class="bd">
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" id="exportBtn">导出数据(JSON)</button>
            <label class="btn ghost" for="importFile">导入数据</label>
            <input type="file" id="importFile" accept="application/json" hidden>
            <button class="btn" id="printBtn">打印学习日报</button>
            <button class="btn danger" id="resetAll">恢复出厂(危险)</button>
          </div>
          <div class="muted" style="margin-top:6px">所有数据保存在浏览器 <code>localStorage</code> 中；如需多设备同步，右上角登录后将自动同步至云端。</div>
        </div>
      </div>
    </div>
  </main>

  <dialog id="onboard">
    <form method="dialog" style="min-width: min(520px, 90vw);">
      <h3>首次设置</h3>
      <p class="muted">以下设置可随时在页面中修改。</p>
      <div class="row" style="gap:10px; align-items:center">
        <label>初试日期：</label>
        <input type="date" id="obDate">
      </div>
      <div class="row" style="gap:10px; align-items:center; margin-top:8px">
        <label>每日目标(分钟)：</label>
        <input type="number" id="obGoal" min="30" step="5" value="180" style="width:120px">
      </div>
      <div style="margin-top:12px">
        <details>
          <summary>一键插入示例任务与词汇</summary>
          <div class="muted">将为“英语二 / 政治 / 生化 / 分子生物学 / 微生物”插入若干示例任务；词汇卡片插入 6 条示例。</div>
          <label class="row" style="margin-top:6px"><input type="checkbox" id="obSeed" checked> 插入示例数据</label>
        </details>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:14px">
        <button class="btn ghost" value="cancel">跳过</button>
        <button class="btn primary" value="ok">完成</button>
      </div>
    </form>
  </dialog>

  <script>
  // ===== 基础工具 =====
  const KEYP = 'ke_bio_v1_'; // ← 全新前缀：不会读取旧版数据
  const store = {
    get(k, def){ try{ const v = localStorage.getItem(KEYP+k); return v ? JSON.parse(v) : (def ?? null)}catch{ return def ?? null } },
    set(k, v){ localStorage.setItem(KEYP+k, JSON.stringify(v)); },
    del(k){ localStorage.removeItem(KEYP+k); },
    all(){ const o={}; try{ for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); if(k && k.startsWith(KEYP)){ try{o[k]=JSON.parse(localStorage.getItem(k))}catch{} } } }catch{} return o; }
  };
  window.__KE_PREFIX__ = KEYP;

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt2 = n => String(n).padStart(2,'0');
  const todayKey = (d=new Date()) => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const ymd = d => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;
  const monday = d => { const t=new Date(d); const w=(t.getDay()+6)%7; t.setDate(t.getDate()-w); t.setHours(0,0,0,0); return t; };
  const addDays = (d, n) => { const t=new Date(d); t.setDate(t.getDate()+n); return t; };

  // 主题 & 时钟
  const themeBtn = $('#themeBtn');
  function applyTheme(){ document.documentElement.setAttribute('data-theme', store.get('theme','dark')); }
  if(store.get('theme', null)===null){ store.set('theme','dark'); }
  themeBtn.onclick = () => { const t = store.get('theme','dark')==='dark'?'light':'dark'; store.set('theme', t); applyTheme(); };
  applyTheme();
  function tickNow(){ const d=new Date(); const s=`${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())} ${fmt2(d.getHours())}:${fmt2(d.getMinutes())}:${fmt2(d.getSeconds())}`; $('#now').textContent=s; }
  setInterval(tickNow, 1000); tickNow();

  // —— 默认时间表 / 阶段
  const defaultTT = [
    {time:'07:30–08:00', title:'英语热身（词汇/朗读）'},
    {time:'08:00–09:50', title:'生化 精读 + 例题（番茄 50/10 ×2）'},
    {time:'10:00–11:50', title:'英语二 长难句/阅读（分项）'},
    {time:'12:00–13:20', title:'午餐 + 休息20min'},
    {time:'13:30–15:20', title:'分子生物学 精读 + 题目'},
    {time:'15:30–16:20', title:'政治 1000题 选择训练（40–50题）'},
    {time:'16:30–17:15', title:'微生物 记忆/框架复盘'},
    {time:'17:45–18:15', title:'晚餐'},
    {time:'19:00–20:20', title:'英语二 真题/翻译/作文'},
    {time:'20:30–21:20', title:'专业课轮背（生化/分子/微生）'},
    {time:'21:20–22:00', title:'复盘卡（错题3条/收获3条/明日3事）'}
  ];
  const phases = [
    {name:'阶段1｜基础夯实', weeks:4, goals:{
      eng:'长难句 20句/周；阅读 6篇/周；翻译段落 2 段/周',
      pol:'《1000题》第一遍：选择题 50题/日 ×5天',
      bio:'生化：代谢/酶/蛋白质结构通读+配套题',
      mol:'分子：DNA 复制/转录/翻译框架与核心机制',
      mic:'微生：细菌/真菌/病毒基础 + 常见菌属识记'
    }},
    {name:'阶段2｜二刷与专题突破', weeks:4, goals:{
      eng:'分项强化（阅读/翻译/完形/新题型）；作文素材 2 篇/周',
      pol:'《1000题》第二遍 + 主观题框架',
      bio:'生化专题：糖代谢/脂代谢/氨基酸代谢整合',
      mol:'分子：基因表达调控/基因工程与载体',
      mic:'微生：培养/染色/灭菌消毒/抗菌药基础'
    }},
    {name:'阶段3｜真题主攻', weeks:4, goals:{
      eng:'真题整套 每周 1–2 套；作文 A/B 各 1 篇',
      pol:'选择题第三遍 + 时政开始整理',
      bio:'生化真题/模拟题：3 天一套 + 2 天剖析',
      mol:'分子综合大题：每周 1–2 次仿真书写',
      mic:'微生高频名词解释/简答滚动背诵'
    }},
    {name:'阶段4｜模拟拔高', weeks:4, goals:{
      eng:'周末全真；工作日纠错 + 语法/翻译薄弱环',
      pol:'主观题模板定稿 + 时政强化',
      bio:'生化错题清零 + 高频易混梳理',
      mol:'分子要点卡片化 + 图表过一遍',
      mic:'微生案例/实验设计题训练'
    }},
    {name:'阶段5｜冲刺查缺', weeks:3, goals:{
      eng:'作文每日快写 1 篇；完形/新题型轻维护',
      pol:'背诵每日三遍（早/午/晚）；预测题回看',
      bio:'生化/分子/微生 高频考点每日滚动背',
      mol:'错题二次订正（按错误类型归档）',
      mic:'名词解释/简答速背+默写'
    }}
  ];

  // —— 首次加载：写入默认数据（不会覆盖已有数据）
  function seedTasksBio(){
    const d = ymd(new Date());
    return [
      {id:crypto.randomUUID(), title:'真题阅读 1 篇 + 精读（标生词/结构）', subject:'英语二', due:d, pri:'P1', est:50, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'长难句 10 句 + 翻译 2 段', subject:'英语二', due:d, pri:'P2', est:45, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'《1000题》选择 40–50 题（马原/思修任一）', subject:'政治', due:d, pri:'P2', est:40, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'生化 · 糖代谢通路梳理 + 例题 3 题', subject:'生化', due:d, pri:'P1', est:90, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'分子生物学 · DNA 复制机制要点 + 例题 2 题', subject:'分子生物学', due:d, pri:'P2', est:70, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'微生物 · 细菌形态/培养基记忆（30min）', subject:'微生物', due:d, pri:'P3', est:30, done:false, createdAt:Date.now()}
    ];
  }

  function ensureDefaults(){
    if(!store.get('examDate', null)) store.set('examDate', '2025-12-20');
    if(store.get('goalMin', null)==null) store.set('goalMin', 180);
    if(!store.get('timetable', null)) store.set('timetable', defaultTT);

    if(!store.get('phaseWeeks', null)){
      const weeks = [];
      let cur = monday(new Date()); // 从本周一开始顺排 19 周
      phases.forEach(ph=>{
        for(let i=0;i<ph.weeks;i++){
          const s = new Date(cur);
          const e = addDays(cur, 6);
          weeks.push({idx: weeks.length+1, phase: ph.name, start: ymd(s), end: ymd(e), goals: ph.goals});
          cur = addDays(cur, 7);
        }
      });
      store.set('phaseWeeks', weeks);
      store.set('curWeekIdx', 1);
    }

    if(store.get('tasks', null)===null){
      store.set('tasks', seedTasksBio()); // ← 直接预置新学科任务
    }
  }
  ensureDefaults();

  // 倒计时
  const examDateInput = $('#examDate');
  function readExamDate(){ const s = store.get('examDate', null); if(s) examDateInput.value = s; }
  function saveExamDate(){ const v = examDateInput.value; if(v) store.set('examDate', v); }
  examDateInput.addEventListener('change', ()=>{ saveExamDate(); updateCountdown(); buildCalendar(); });
  function updateCountdown(){
    const s = examDateInput.value; const dLeftEl = $('#dLeft');
    if(!s){ dLeftEl.textContent = '--'; return; }
    const tgt = new Date(s+'T00:00:00'); const now = new Date();
    const ms = tgt - now; const days = Math.ceil(ms / 86400000);
    dLeftEl.textContent = days >= 0 ? days : 0;
  }
  readExamDate(); updateCountdown(); setInterval(updateCountdown, 60000);

  // 番茄钟
  const cfg = { work: store.get('cfg_work',25), short: store.get('cfg_short',5), long: store.get('cfg_long',15), every: store.get('cfg_every',4) };
  $('#cfgWork').value = cfg.work; $('#cfgShort').value = cfg.short; $('#cfgLong').value = cfg.long; $('#cfgEvery').value = cfg.every;
  ['cfgWork','cfgShort','cfgLong','cfgEvery'].forEach(id=>{
    $('#'+id).addEventListener('change',()=>{
      cfg.work=+$('#cfgWork').value; cfg.short=+$('#cfgShort').value; cfg.long=+$('#cfgLong').value; cfg.every=+$('#cfgEvery').value;
      store.set('cfg_work',cfg.work); store.set('cfg_short',cfg.short); store.set('cfg_long',cfg.long); store.set('cfg_every',cfg.every);
      if(state.mode==='work') state.left=cfg.work*60; renderPomodoro();
    });
  });
  const state = { mode: 'work', left: cfg.work*60, running: false, timer: null, cycle: store.get('cycle',1) };
  function setMode(m){ state.mode=m; if(m==='work') state.left=cfg.work*60; if(m==='short') state.left=cfg.short*60; if(m==='long') state.left=cfg.long*60; renderPomodoro(); }
  function nextMode(){ if(state.mode==='work'){ if(state.cycle % cfg.every === 0){ setMode('long'); } else { setMode('short'); } } else { state.cycle++; store.set('cycle', state.cycle); setMode('work'); } }
  function renderPomodoro(){
    $('#time').textContent = `${fmt2(Math.floor(state.left/60))}:${fmt2(Math.floor(state.left%60))}`;
    $('#modeLabel').textContent = state.mode==='work'?'专注模式':(state.mode==='short'?'短休模式':'长休模式');
    $('#cycleInfo').textContent = `第 ${state.cycle} 轮`;
    $$('.modes .btn').forEach(b=>{ b.classList.toggle('active', b.dataset.mode===state.mode); });
  }
  function tick(){ if(!state.running) return; state.left--; if(state.left<=0){ completeSession(); nextMode(); } renderPomodoro(); }
  function start(){ if(state.running) return; state.running=true; state.timer=setInterval(tick, 1000); $('#startPause').textContent='暂停'; }
  function pause(){ state.running=false; clearInterval(state.timer); $('#startPause').textContent='开始'; }
  function reset(){ pause(); setMode(state.mode); }
  $('#startPause').onclick=()=>{ state.running?pause():start(); };
  $('#skip').onclick=()=>{ nextMode(); reset(); };
  $('#reset').onclick=()=>{ reset(); };
  function logToday(min, pom=1){
    const key = 'log_'+todayKey();
    const o = store.get(key,{min:0,pom:0, tasks:0});
    o.min += min; o.pom += pom; store.set(key,o);
    updateTodayProgress(); updateKPIs(); drawCharts(); updateGoalBadge(); markCalendarAuto();
  }
  function completeSession(){ if(state.mode==='work'){ logToday(cfg.work,1); } }

  function getAggregates(rangeDays=14){
    const arr=[]; const today=new Date();
    for(let i=rangeDays-1;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); const k='log_'+todayKey(d); const o=store.get(k,{min:0,pom:0,tasks:0}); arr.push({date:todayKey(d),...o}); }
    return arr;
  }
  function updateKPIs(){
    const now=new Date(); const dow=(now.getDay()+6)%7; // Mon=0
    const wkStart=new Date(now); wkStart.setDate(now.getDate()-dow);
    let wk=0, mo=0; for(let i=0;i<31;i++){ const d=new Date(now); d.setDate(now.getDate()-i); const k='log_'+todayKey(d); const o=store.get(k,{min:0}); if(d>=wkStart) wk+=o.min; if(d.getMonth()===now.getMonth()) mo+=o.min; }
    $('#wkMin').textContent=wk; $('#moMin').textContent=mo;
    let streak=0; for(let i=0;i<999;i++){ const d=new Date(now); d.setDate(now.getDate()-i); const k='log_'+todayKey(d); const o=store.get(k,null); const goal=+($('#goalMin').value||180); if(o && o.min>=goal) streak++; else break; }
    $('#streak').textContent=streak;
  }
  const goalMin = $('#goalMin'); goalMin.addEventListener('change',()=>{ store.set('goalMin', +goalMin.value); updateGoalBadge(); buildCalendar(); updateKPIs(); }); goalMin.value = store.get('goalMin', 180);
  function updateTodayProgress(){ const o=store.get('log_'+todayKey(),{min:0,pom:0,tasks:0}); $('#todayProgress').textContent=`今日专注 ${o.min} 分钟 · ${o.pom} 个番茄 · ${o.tasks||0} 个任务`; }
  function updateGoalBadge(){ const goal=+goalMin.value; const o=store.get('log_'+todayKey(),{min:0}); const hit = o.min>=goal; const b=$('#goalHit'); b.textContent = hit? '已达成' : '未达成'; b.style.background = hit? 'linear-gradient(135deg, var(--ok), #90e6c2)' : 'var(--panel-hi)'; }
  updateTodayProgress(); updateGoalBadge(); updateKPIs();

  // 待办
  let tasks = store.get('tasks', []);
  const subjects = ['英语二','政治','生化','分子生物学','微生物','其他'];
  const filterBar = $('#filterBar');
  let curFilter = store.get('filter','全部');
  function renderFilters(){
    filterBar.innerHTML='';
    ['全部',...subjects].forEach(s=>{
      const b=document.createElement('button'); b.className='btn pill'+(curFilter===s?' active':''); b.textContent=s; b.onclick=()=>{ curFilter=s; store.set('filter',s); renderTasks(); renderFilters(); };
      filterBar.appendChild(b);
    })
  }
  renderFilters();

  function addTask(t){ tasks.push(t); store.set('tasks', tasks); renderTasks(); }
  function removeTask(id){ tasks = tasks.filter(x=>x.id!==id); store.set('tasks', tasks); renderTasks(); }
  function updateTask(id,patch){ const i=tasks.findIndex(x=>x.id===id); if(i>-1){ tasks[i]=Object.assign({},tasks[i],patch); store.set('tasks', tasks); renderTasks(); } }
  function renderTasks(){
    const box = $('#taskList'); box.innerHTML='';
    let arr = tasks.slice().sort((a,b)=>a.done-b.done || (a.pri>b.pri?1:-1) || (a.due||'').localeCompare(b.due||''));
    if(curFilter!=='全部') arr = arr.filter(t=>t.subject===curFilter);
    arr.forEach(t=> box.appendChild(renderTaskItem(t)));
  }
  function renderTaskItem(t){
    const el=document.createElement('div'); el.className='task'+(t.done?' done':''); el.draggable=true; el.dataset.id=t.id;
    el.innerHTML=`<input type="checkbox" ${t.done?'checked':''} aria-label="完成任务">
      <div>
        <div class="title">${escapeHtml(t.title)} <span class="tag">${t.subject}</span></div>
        <div class="meta">优先级: ${t.pri} ${t.due?(' · 截止: '+t.due):''} · 预计: ${t.est||25}分</div>
      </div>
      <div class="row">
        <button class="btn icon" data-act="inc">＋5分</button>
        <button class="btn icon" data-act="edit">✎</button>
        <button class="btn icon" data-act="del">🗑</button>
      </div>`;
    el.querySelector('input').onchange = (e)=>{ updateTask(t.id,{done:e.target.checked}); if(e.target.checked){
        const key='log_'+todayKey(); const lg = store.get(key,{min:0,pom:0,tasks:0}); lg.tasks=(lg.tasks||0)+1; store.set(key,lg); updateTodayProgress(); drawCharts(); updateGoalBadge(); updateKPIs(); buildCalendar();
    }}; 
    el.querySelector('[data-act="del"]').onclick=()=> removeTask(t.id);
    el.querySelector('[data-act="inc"]').onclick=()=> { updateTask(t.id,{est:(t.est||25)+5}); };
    el.querySelector('[data-act="edit"]').onclick=()=> editTask(t);
    el.addEventListener('dragstart',()=>{ el.classList.add('dragging'); });
    el.addEventListener('dragend',()=>{ el.classList.remove('dragging'); saveOrder(); });
    el.addEventListener('dragover',(e)=>{ e.preventDefault(); const dragging = document.querySelector('.task.dragging'); if(!dragging||dragging===el) return; const box=el.parentElement; const items=[...box.children]; const draggingIdx=items.indexOf(dragging); const elIdx=items.indexOf(el); if(draggingIdx<elIdx){ box.insertBefore(dragging, el.nextSibling);} else { box.insertBefore(dragging, el);} });
    return el;
  }
  function saveOrder(){ const ids=[...$('#taskList').children].map(n=>n.dataset.id); tasks.sort((a,b)=> ids.indexOf(a.id)-ids.indexOf(b.id)); store.set('tasks', tasks); }
  function editTask(t){ const nv = prompt('修改任务内容', t.title); if(nv!==null){ updateTask(t.id,{title:nv}); }}
  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  $('#addTask').onclick=()=> doAdd();
  function doAdd(){
    const title=$('#taskTitle').value.trim(); if(!title){ $('#taskTitle').focus(); return; }
    const subject=$('#taskSubject').value; const due=$('#taskDue').value||null; const pri=$('#taskPri').value; const est=25;
    addTask({id:crypto.randomUUID(), title, subject, due, pri, est, done:false, createdAt:Date.now()});
    $('#taskTitle').value=''; $('#taskTitle').focus();
  }
  $('#taskTitle').addEventListener('keydown',e=>{ if(e.key==='Enter'){ doAdd(); }});
  $('#clearDone').onclick=()=>{ if(confirm('确认删除所有已完成任务？')){ tasks=tasks.filter(t=>!t.done); store.set('tasks',tasks); renderTasks(); }}
  $('#tplBtn').onclick=()=> insertTemplates();

  function insertTemplates(){
    const tpl=[
      {s:'英语二', t:'真题阅读 1 篇 + 精读（标生词/结构）'},
      {s:'英语二', t:'长难句 10 句 + 翻译 2 段'},
      {s:'政治', t:'1000题 · 马原/思修 40–50 题'},
      {s:'生化', t:'代谢总览框架图 + 例题 3 题'},
      {s:'分子生物学', t:'基因表达调控要点 + 例题 2 题'},
      {s:'微生物', t:'灭菌/消毒方法与原理（30min）'}
    ];
    tpl.forEach(x=> addTask({id:crypto.randomUUID(), title:x.t, subject:x.s, due:null, pri:'P2', est:25, done:false, createdAt:Date.now()}));
  }
  renderTasks();

  // 打卡日历
  let curYM = (d=>({y:d.getFullYear(), m:d.getMonth()+1}))(new Date());
  function buildCalendar(){
    const y=curYM.y, m=curYM.m; $('#ymLabel').textContent=`${y}年${m}月`;
    const box=$('#calendar'); box.innerHTML='';
    const first=new Date(y, m-1, 1); const startDow=(first.getDay()+6)%7;
    const days=new Date(y, m, 0).getDate();
    for(let i=0;i<startDow;i++){ const ph=document.createElement('div'); box.appendChild(ph); }
    for(let d=1; d<=days; d++){
      const el=document.createElement('div'); el.className='day';
      const dateStr=`${y}-${fmt2(m)}-${fmt2(d)}`;
      const lg=store.get('log_'+dateStr,null); const goal=+($('#goalMin').value||180);
      const good = lg && (lg.min||0) >= goal; const bad = lg && (lg.min||0) > 0 && (lg.min||0) < goal;
      if(good) el.classList.add('good'); if(bad) el.classList.add('bad');
      el.innerHTML=`<div class="d">${d}</div><div class="dot"></div>`;
      el.title = `${dateStr}：专注 ${(lg?.min||0)} 分钟 · 番茄 ${(lg?.pom||0)} · 任务 ${(lg?.tasks||0)}`;
      el.onclick=()=>{ const o = store.get('log_'+dateStr,{min:0,pom:0,tasks:0}); const goal=+($('#goalMin').value||180); const newMin = (o.min>=goal)?0:goal; o.min=newMin; store.set('log_'+dateStr,o); if(dateStr===todayKey()) { updateGoalBadge(); updateTodayProgress(); updateKPIs(); } buildCalendar(); drawCharts(); };
      box.appendChild(el);
    }
  }
  function markCalendarAuto(){ buildCalendar(); }
  $('#prevMonth').onclick=()=>{ const d=new Date(curYM.y,curYM.m-2,1); curYM={y:d.getFullYear(), m:d.getMonth()+1}; buildCalendar(); };
  $('#nextMonth').onclick=()=>{ const d=new Date(curYM.y,curYM.m,1); curYM={y:d.getFullYear(), m:d.getMonth()+1}; buildCalendar(); };
  $('#markToday').onclick=()=>{ const t=todayKey(); const o=store.get('log_'+t,{min:0,pom:0,tasks:0}); const g=+($('#goalMin').value||180); o.min=Math.max(o.min, g); store.set('log_'+t,o); updateGoalBadge(); updateTodayProgress(); updateKPIs(); buildCalendar(); };
  buildCalendar();

  // 笔记
  const editor=$('#editor'); editor.innerHTML = store.get('notes','');
  editor.addEventListener('input',()=> store.set('notes', editor.innerHTML));
  $$('.toolbar [data-cmd]').forEach(b=> b.onclick=()=> document.execCommand(b.dataset.cmd,false,null));
  $('#h1Btn').onclick=()=> document.execCommand('formatBlock', false, 'H2');
  $('#clearNotes').onclick=()=>{ if(confirm('是否清空笔记？此操作不可撤销。')){ editor.innerHTML=''; store.set('notes',''); }}

  // 词汇
  let vocabs = store.get('vocabs', []);
  function saveVocabs(){ store.set('vocabs', vocabs); renderCards(); }
  function addCard(w,m){ vocabs.push({id:crypto.randomUUID(), w, m, ef:2.5, due: Date.now() }); saveVocabs(); }
  $('#addVocab').onclick=()=>{ const w=$('#vWord').value.trim(); const m=$('#vMean').value.trim(); if(!w||!m) return; addCard(w,m); $('#vWord').value=''; $('#vMean').value=''; };
  $('#shuffle').onclick=()=>{ vocabs.sort(()=>Math.random()-.5); saveVocabs(); };
  function renderCards(){ const box=$('#vCards'); box.innerHTML=''; vocabs.forEach(v=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="word">${escapeHtml(v.w)}</div><div class="mean">${escapeHtml(v.m)}</div><div class="row" style="justify-content:center; margin-top:6px"><button class="btn icon" data-act="del">🗑</button></div>`; c.querySelector('[data-act="del"]').onclick=()=>{ vocabs=vocabs.filter(x=>x.id!==v.id); saveVocabs(); }; box.appendChild(c); }); }
  renderCards();
  let quizQ=[], qi=0, showBack=false;
  function startQuiz(){ quizQ = vocabs.slice().filter(v=> v.due <= Date.now()).sort(()=>Math.random()-.5); if(quizQ.length===0) quizQ=vocabs.slice().sort(()=>Math.random()-.5); qi=0; showBack=false; $('#quizBox').hidden=false; nextQ(); }
  function nextQ(){ if(quizQ.length===0){ $('#quizBox').hidden=true; return; } const v=quizQ[qi%quizQ.length]; $('#qFront').textContent=v.w; $('#qBack').textContent=v.m; $('#qBack').hidden=true; $('#qMeta').textContent=`${(qi%quizQ.length)+1} / ${quizQ.length}`; showBack=false; }
  $('#startQuiz').onclick=()=> startQuiz();
  $('#reveal').onclick=()=>{ $('#qBack').hidden = !showBack; showBack = !showBack; };
  $('#know').onclick=()=> score(5);
  $('#dont').onclick=()=> score(2);
  function score(q){ const v=quizQ[qi%quizQ.length];
    const addMs = (q>=4) ? (86400000 * (2 + Math.random()*2)) : (600000 * (1 + Math.random()*5));
    v.due = Date.now() + addMs; saveVocabs(); qi++; if(qi>=quizQ.length) { qi=0; quizQ=quizQ.filter(x=> x.due<=Date.now()); if(quizQ.length===0){ $('#quizBox').hidden=true; return; } }
    nextQ();
  }

  // 统计图
  function drawBar(canvasId, data, labelGetter, valueGetter){
    const cvs=$(canvasId); if(!cvs) return; const ctx=cvs.getContext('2d'); if(!ctx) return; const DPR=window.devicePixelRatio||1; const W=cvs.clientWidth*DPR, H=cvs.clientHeight*DPR; cvs.width=W; cvs.height=H; ctx.clearRect(0,0,W,H);
    const pad=20*DPR; const innerW=W-pad*2; const innerH=H-pad*2; ctx.font = 12*DPR+'px '+getComputedStyle(document.body).fontFamily; ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
    const max = Math.max(1, ...data.map(valueGetter));
    const n=data.length; const barW=innerW/n*0.72; const gap=(innerW/n - barW);
    ctx.globalAlpha=.5; ctx.fillRect(pad, pad+innerH, innerW, 1); ctx.globalAlpha=1;
    data.forEach((d,i)=>{
      const v=valueGetter(d); const h= v/max * (innerH-10*DPR); const x=pad + i*(barW+gap) + gap/2; const y=pad+innerH - h;
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--brand'); ctx.fillRect(x, y, barW, h);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text'); ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(String(v), x+barW/2, y-2*DPR);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted'); ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText(labelGetter(d), x+barW/2, pad+innerH + 12*DPR);
    });
  }
  function drawCharts(){
    const agg=getAggregates(14);
    drawBar('#chartMin', agg, d=>d.date.slice(5), d=>d.min);
    drawBar('#chartTask', agg, d=>d.date.slice(5), d=>d.tasks||0);
  }
  window.addEventListener('resize', drawCharts); drawCharts();

  // 链接
  let links = store.get('links', []);
  function renderLinks(){ const box=$('#links'); box.innerHTML=''; links.forEach(l=>{ const a=document.createElement('div'); a.className='task'; a.innerHTML=`<div style="width:10px; height:10px; border-radius:50%; background:var(--brand)"></div>
      <div><div class="title"><a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">${escapeHtml(l.title)}</a></div>
      <div class="meta">${escapeHtml(l.url)}</div></div>
      <div class="row"><button class="btn icon" data-act="del">🗑</button></div>`; a.querySelector('[data-act="del"]').onclick=()=>{ links=links.filter(x=>x.id!==l.id); store.set('links',links); renderLinks(); }; box.appendChild(a); }); }
  renderLinks();
  $('#addLink').onclick=()=>{ const t=$('#linkTitle').value.trim(); const u=$('#linkUrl').value.trim(); if(!t||!u) return; links.push({id:crypto.randomUUID(), title:t, url:u}); store.set('links',links); renderLinks(); $('#linkTitle').value=''; $('#linkUrl').value=''; };

  // 阶段周计划 & 时间表
  function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }
  function cnRange(a,b){ const A=parseYMD(a), B=parseYMD(b); return `${A.getMonth()+1}/${A.getDate()}–${B.getMonth()+1}/${B.getDate()}`; }
  function renderWeekPlan(){
    const ws = store.get('phaseWeeks', []);
    if(!ws.length) return;
    let idx = clamp(store.get('curWeekIdx',1), 1, ws.length);
    store.set('curWeekIdx', idx);
    const w = ws[idx-1];
    $('#phaseLabel').textContent = w.phase;
    $('#wkLabel').textContent = `第 ${w.idx} 周 · ${cnRange(w.start, w.end)}`;
    const g = w.goals;
    $('#wkGoals').innerHTML = [
      `<li><b>英语二</b>：${g.eng}</li>`,
      `<li><b>政治</b>：${g.pol}</li>`,
      `<li><b>生化</b>：${g.bio}</li>`,
      `<li><b>分子生物学</b>：${g.mol}</li>`,
      `<li><b>微生物</b>：${g.mic}</li>`
    ].join('');
  }
  function renderTimetable(){
    const tt = store.get('timetable', []);
    const html = tt.map(b=>`<div class="tt-row"><div class="tt-time">${b.time}</div><div>${escapeHtml(b.title)}</div></div>`).join('');
    $('#ttBox').innerHTML = html;
  }
  const wkPrev = document.getElementById('wkPrev');
  const wkNext = document.getElementById('wkNext');
  if(wkPrev && wkNext){
    wkPrev.onclick = ()=>{ const n = clamp(store.get('curWeekIdx',1)-1, 1, store.get('phaseWeeks',[]).length); store.set('curWeekIdx', n); renderWeekPlan(); };
    wkNext.onclick = ()=>{ const n = clamp(store.get('curWeekIdx',1)+1, 1, store.get('phaseWeeks',[]).length); store.set('curWeekIdx', n); renderWeekPlan(); };
  }

  function majorMinorForWeek(weekIdx){
    const order = ['生化','分子生物学','微生物'];
    const major = order[(weekIdx-1)%3];
    const minor = order[(weekIdx)%3];
    return {major, minor};
  }
  const pushWeekBtn = document.getElementById('pushWeek');
  if(pushWeekBtn){ pushWeekBtn.onclick = ()=> dispatchWeek(store.get('curWeekIdx',1)); }
  const pushAllBtn = document.getElementById('pushAll');
  if(pushAllBtn){
    pushAllBtn.onclick = ()=>{
      const ws = store.get('phaseWeeks', []);
      if(!ws.length) return;
      ws.forEach(w=> dispatchWeek(w.idx, false));
      alert('已生成全部 19 周的待办清单（带各周截止日）。');
      renderTasks();
    };
  }
  function dispatchWeek(idx, showAlert=true){
    const ws = store.get('phaseWeeks', []);
    if(!ws.length) return;
    const w = ws[clamp(idx,1,ws.length)-1];
    const s = parseYMD(w.start);
    const due = i => ymd(new Date(s.getFullYear(), s.getMonth(), s.getDate()+i));
    const {major, minor} = majorMinorForWeek(w.idx);
    const weekdayPack = [0,1,2,3,4].flatMap(i=>[
      {t:`英语二 · 阅读/长难句分项（45–60min）`, s:'英语二', d:due(i), p:'P1', est:50},
      {t:`政治 · 《1000题》选择 40–50题`, s:'政治', d:due(i), est:40},
      {t:`${major} · 主修训练（精读+题目 90–110min）`, s:major, d:due(i), p:'P1', est:100},
      {t:`${minor} · 记忆巩固（关键概念/名词解释 30min）`, s:minor, d:due(i), est:30}
    ]);
    const weekendPack = [
      {t:`英语二 · 作文练习 1 篇（A/B 轮换）`, s:'英语二', d:due(5), est:40},
      {t:`${major} · 综合大题仿真（90min）`, s:major, d:due(5), est:90},
      {t:`政治 · 错题整理（40min）`, s:'政治', d:due(5), est:40},
      {t:`周复盘：错题TOP5重做 + 得失总结（60min）`, s:'其他', d:due(6), est:60},
      {t:`下周三件大事规划（20min）`, s:'其他', d:due(6), est:20}
    ];
    [...weekdayPack, ...weekendPack].forEach(x=> addTask({
      id:crypto.randomUUID(), title:x.t, subject:x.s, due:x.d, pri:x.p||'P2', est:x.est||25, done:false, createdAt:Date.now()
    }));
    if(showAlert) { alert(`已生成：第 ${w.idx} 周（${cnRange(w.start,w.end)}）的待办清单`); }
  }

  // 备份 / 导入 / 打印 / 恢复
  $('#exportBtn').onclick=()=>{ const data = store.all(); const blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`kaoyan-bio-data-${todayKey()}.json`; a.click(); URL.revokeObjectURL(a.href); };
  $('#importFile').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{ try{
      const raw=JSON.parse(fr.result); for(const k in raw){ localStorage.setItem(k, JSON.stringify(raw[k])); }
      alert('导入完成，页面将刷新'); location.reload();
    }catch(err){ alert('导入失败：'+err.message); } }; fr.readAsText(file);
  });
  $('#printBtn').onclick=()=> window.print();
  $('#resetAll').onclick=()=>{ if(confirm('确认清空本应用的所有数据？此操作不可撤销。')){ Object.keys(localStorage).filter(k=>k.startsWith(KEYP)).forEach(k=>localStorage.removeItem(k)); location.reload(); } };

  // 首设向导
  const ob=$('#onboard'); $('#onboardBtn').onclick=()=> ob.showModal && ob.showModal();
  if(!store.get('booted', false)){
    if('HTMLDialogElement' in window && HTMLDialogElement.prototype.showModal){ setTimeout(()=>ob.showModal(), 400); }
    else { ob.setAttribute('open',''); }
  }
  ob.addEventListener('close',()=>{
    if(ob.returnValue==='ok'){
      const dt=$('#obDate').value; if(dt){ store.set('examDate', dt); examDateInput.value=dt; updateCountdown(); buildCalendar(); }
      const gm=+$('#obGoal').value||180; store.set('goalMin', gm); goalMin.value=gm; updateGoalBadge();
      if($('#obSeed').checked){
        ['glycolysis: 糖酵解','replication: 复制','transcription: 转录','translation: 翻译','peptidoglycan: 肽聚糖','operon: 操纵子']
          .forEach(s=>{ const [w,m]=s.split(':').map(x=>x.trim()); addCard(w,m); });
        insertTemplates();
      }
    }
    store.set('booted', true);
  });

  document.addEventListener('keydown', (e)=>{
    if(e.target && (e.target.matches?.('input, textarea, [contenteditable="true"]'))) return;
    if(e.key && e.key.toLowerCase?.()==='n'){ $('#taskTitle').focus(); }
    if(e.code==='Space'){ e.preventDefault(); $('#startPause').click(); }
  });

  setTimeout(()=>{ drawCharts(); updateKPIs(); updateTodayProgress(); renderWeekPlan(); renderTimetable(); }, 200);
  </script>

  <!-- Firebase（保持可选） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAV2sDzzYW6qcQ2YCJUQ_IJxeqbAf27Lgs",
      authDomain: "web-1-13c27.firebaseapp.com",
      projectId: "web-1-13c27",
      storageBucket: "web-1-13c27.firebasestorage.app",
      messagingSenderId: "472569141099",
      appId: "1:472569141099:web:a73ca462c677a53824de2e",
      measurementId: "G-DG6YD17SES"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');

    async function userLogin(){
      const email = prompt("请输入邮箱："); if(!email) return;
      const pwd = prompt("请输入密码："); if(!pwd) return;
      try{
        await signInWithEmailAndPassword(auth, email, pwd);
        alert("登录成功");
      }catch(e){
        if(e.code === 'auth/user-not-found'){
          await createUserWithEmailAndPassword(auth, email, pwd);
          alert("注册成功并已登录");
        }else if(e.code === 'auth/invalid-credential'){
          alert("登录失败：账号或密码不正确。");
        }else{
          alert("登录失败: "+e.message);
        }
      }
    }
    function userLogout(){ signOut(auth).catch(()=>{}); }
    loginBtn.addEventListener('click', userLogin);
    logoutBtn.addEventListener('click', userLogout);

    const KEY_PREFIX = window.__KE_PREFIX__ || 'ke_bio_v1_';
    function collectLocal(){
      const all={};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && k.startsWith(KEY_PREFIX)){
          all[k] = localStorage.getItem(k);
        }
      }
      return all;
    }
    async function syncToCloud(uid){
      const data = collectLocal();
      await setDoc(doc(db, "users", uid), { data }, { merge:true });
      console.log("✅ 已同步到云端", new Date().toISOString());
    }
    async function loadFromCloud(uid){
      const snap = await getDoc(doc(db, "users", uid));
      if(!snap.exists()){ console.log("云端无数据"); return false; }
      const data = snap.data()?.data || {};
      for(let i=localStorage.length-1;i>=0;i--){
        const k=localStorage.key(i);
        if(k && k.startsWith(KEY_PREFIX)) localStorage.removeItem(k);
      }
      Object.keys(data).forEach(k=> localStorage.setItem(k, data[k]));
      console.log("⬇ 已从云端加载数据");
      return true;
    }

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        authStatus.textContent = user.email || '已登录';
        loginBtn.hidden = true;
        logoutBtn.hidden = false;
        const loaded = await loadFromCloud(user.uid);
        if(loaded && !sessionStorage.getItem('reloadedAfterCloud')){
          sessionStorage.setItem('reloadedAfterCloud','1');
          location.reload(); return;
        }
        if(!window.__syncTimer__){
          window.__syncTimer__ = setInterval(()=>syncToCloud(user.uid), 30000);
        }
        window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden'){ syncToCloud(user.uid).catch(()=>{}); }});
      }else{
        authStatus.textContent = '未登录';
        loginBtn.hidden = false;
        logoutBtn.hidden = true;
        if(window.__syncTimer__){ clearInterval(window.__syncTimer__); window.__syncTimer__=null; }
      }
    });
  </script>
</body>
</html>
