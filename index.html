<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è€ƒç ”å­¦ä¹ å·¥ä½œå° Â· ç”Ÿç‰©æŠ€æœ¯ç‰ˆï¼ˆå•æ–‡ä»¶ + äº‘åŒæ­¥ï¼‰</title>
  <meta name="description" content="å•æ–‡ä»¶è€ƒç ”å­¦ä¹ å·¥ä½œå°ï¼ˆç”Ÿç‰©æŠ€æœ¯ï¼‰ï¼šå¾…åŠã€ç•ªèŒ„é’Ÿã€å€’è®¡æ—¶ã€æ‰“å¡æ—¥å†ã€è¯æ±‡å¡ç‰‡ã€ç¬”è®°ã€ç»Ÿè®¡ã€é˜¶æ®µå‘¨è®¡åˆ’ã€æ—¶é—´è§„åˆ’è¡¨ã€å¤‡ä»½/è¿˜åŸã€è´¦å·äº‘åŒæ­¥ã€‚æ•°æ®æœ¬åœ°ä¿å­˜å¹¶å¯åŒæ­¥åˆ°äº‘ç«¯ã€‚" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --panel-hi: #16202b;
      --text: #eaeef3;
      --muted: #a8b3c1;
      --brand: #50a7ff;
      --ok: #34d399;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --gap: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, Helvetica, Arial, sans-serif;
    }
    [data-theme="light"]{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --panel-hi: #f0f3f7;
      --text: #0f1621;
      --muted: #66707b;
      --brand: #2b78ff;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% 0%, rgba(80,167,255,.10), transparent 60%),
      radial-gradient(1000px 600px at 100% 20%, rgba(52,211,153,.10), transparent 60%), var(--bg);
      color:var(--text); font-family:var(--font); line-height:1.5; overflow-y:overlay;
    }
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(130%) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0)), var(--panel);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar{max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:10px; align-items:center}
    .title{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .title .logo{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #34d399); box-shadow:var(--shadow)}
    .grow{flex:1}
    .btn{appearance:none; border:none; padding:9px 12px; border-radius:10px; background:var(--panel-hi); color:var(--text); cursor:pointer; box-shadow:var(--shadow);
      transition:transform .05s ease, background .2s ease, opacity .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.icon{padding:8px; display:inline-grid; place-items:center}
    .btn.primary{background:linear-gradient(135deg, var(--brand), #7cc2ff)}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .btn.danger{background:linear-gradient(135deg, var(--danger), #ff8a8a)}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--panel-hi); font-size:12px; color:var(--muted)}
    main{max-width:1200px; margin:18px auto 40px; padding:0 16px;}
    .grid{display:grid; grid-template-columns: 330px 1fr; gap:var(--gap)}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius-lg); box-shadow:var(--shadow)}
    .panel .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10)}
    .panel .bd{padding:14px}
    .muted{color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .kpi .card{padding:12px; background:var(--panel-hi); border-radius:12px; text-align:center}
    .kpi .num{font-size:22px; font-weight:700}

    .countdown{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .countdown .box{padding:10px; background:var(--panel-hi); border-radius:12px}
    .countdown .big{font-size:28px; font-weight:800}

    .pomodoro{display:grid; gap:10px}
    .pomodoro .screen{display:grid; place-items:center; padding:18px; background:var(--panel-hi); border-radius:12px; font-variant-numeric: tabular-nums;}
    .pomodoro .time{font-size:42px; font-weight:800}
    .pomodoro .modes{display:flex; gap:6px; flex-wrap:wrap; justify-content:center}
    .pomodoro .modes .btn{border-radius:999px; padding:6px 10px}
    .row{display:flex; gap:6px; flex-wrap:wrap; align-items:center}

    .todo-header{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{border-radius:999px; padding:6px 10px; background:var(--panel-hi); cursor:pointer; user-select:none}
    .pill.active{outline:2px solid var(--brand)}
    .todo-inputs{display:grid; grid-template-columns:1.6fr .9fr .9fr .6fr auto; gap:8px; margin-top:10px}
    @media (max-width:900px){.todo-inputs{grid-template-columns:1.5fr .9fr .9fr .7fr}}
    @media (max-width:640px){.todo-inputs{grid-template-columns:1fr}}
    input, select, textarea{width:100%; background:var(--panel-hi); color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px; outline:none}
    input::placeholder, textarea::placeholder{color:rgba(168,179,193,.7)}

    .task{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px dashed rgba(255,255,255,.16); margin-bottom:8px; background:linear-gradient(0deg, rgba(22,32,43,.7), transparent)}
    .task.dragging{opacity:.6}
    .task .title{font-weight:600}
    .task .meta{font-size:12px; color:var(--muted)}
    .task .tag{font-size:12px; padding:3px 8px; border-radius:999px; background:rgba(80,167,255,.20); margin-left:6px}
    .task.done{opacity:.6; text-decoration:line-through}

    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px}
    .day{aspect-ratio:1/1; border-radius:10px; background:var(--panel-hi); display:flex; flex-direction:column; padding:6px; cursor:pointer; position:relative}
    .day .d{font-size:12px; color:var(--muted)}
    .day .dot{width:8px; height:8px; border-radius:50%; position:absolute; right:6px; bottom:6px; background:var(--muted)}
    .day.good .dot{background:var(--ok)}
    .day.bad .dot{background:var(--danger)}
    .dow{font-size:12px; color:var(--muted); text-align:center; margin-bottom:6px}

    .toolbar{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px}
    .editor{min-height:180px; padding:12px; border-radius:12px; background:var(--panel-hi); outline:none}

    .vocab{display:grid; gap:8px}
    .card{border-radius:12px; padding:16px; background:var(--panel-hi); text-align:center}
    .card .word{font-size:26px; font-weight:800}
    .card .mean{margin-top:6px; color:var(--muted)}

    .stats-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){.stats-grid{grid-template-columns:1fr}}
    canvas{width:100%; height:220px}

    .wk-list{margin:0; padding-left:18px}
    .wk-list li{margin:6px 0}
    .tt-row{display:grid; grid-template-columns:120px 1fr; gap:10px; padding:10px; border-radius:12px;
      background:var(--panel-hi); border:1px dashed rgba(255,255,255,.16); margin-bottom:8px}
    .tt-time{font-weight:700; color:var(--muted)}

    @media print{
      header, .no-print{display:none !important}
      body{background:#fff}
      .panel{box-shadow:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title" aria-label="å“ç‰Œæ ‡è¯†ä¸æ ‡é¢˜">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div>è€ƒç ”å­¦ä¹ å·¥ä½œå° Â· ç”Ÿç‰©æŠ€æœ¯</div>
          <div class="muted" style="font-size:12px">æœ¬åœ°è¿è¡Œ Â· å•æ–‡ä»¶ Â· ç¦»çº¿å¯ç”¨ Â· æ”¯æŒäº‘åŒæ­¥</div>
        </div>
      </div>
      <div class="grow"></div>
      <span id="now" class="badge" aria-live="polite">--:--</span>
      <span id="authStatus" class="badge">æœªç™»å½•</span>
      <button id="loginBtn" class="btn" title="ç™»å½•/æ³¨å†Œ">ç™»å½•/æ³¨å†Œ</button>
      <button id="logoutBtn" class="btn ghost" title="é€€å‡ºç™»å½•" hidden>é€€å‡º</button>
      <button id="themeBtn" class="btn icon" title="åˆ‡æ¢æ˜/æš—ä¸»é¢˜" aria-label="åˆ‡æ¢æ˜æš—ä¸»é¢˜">ğŸŒ“</button>
      <button id="onboardBtn" class="btn" title="é¦–è®¾å‘å¯¼">åˆå§‹è®¾ç½®</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="panel" id="leftPanel" aria-label="ä¾§è¾¹å·¥ä½œåŒº">
        <div class="hd"><strong>å€’è®¡æ—¶ä¸ç•ªèŒ„é’Ÿ</strong>
          <div class="row">
            <label class="badge" for="examDate">åˆè¯•æ—¥æœŸ</label>
            <input type="date" id="examDate"/>
          </div>
        </div>
        <div class="bd">
          <div class="countdown" aria-label="å€’è®¡æ—¶åŒºå—">
            <div class="box" title="è·ç¦»åˆè¯•"><div class="muted">è·ç¦»åˆè¯•</div><div class="big" id="dLeft">--</div><div class="muted">å¤©</div></div>
            <div class="box" title="ä»Šæ—¥ç›®æ ‡"><div class="muted">ä»Šæ—¥ç›®æ ‡</div>
              <div class="row" style="align-items:center; margin-top:6px">
                <input type="number" id="goalMin" min="10" step="5" value="180" aria-label="ç›®æ ‡åˆ†é’Ÿæ•°"/>
                <span class="muted">åˆ†é’Ÿ</span>
                <span class="badge" id="goalHit">æœªè¾¾æˆ</span>
              </div>
              <div class="muted" id="todayProgress" style="margin-top:6px">ä»Šæ—¥ä¸“æ³¨ 0 åˆ†é’Ÿ Â· 0 ä¸ªç•ªèŒ„</div>
            </div>
          </div>

          <div class="pomodoro" aria-label="ç•ªèŒ„é’Ÿ">
            <div class="modes">
              <button class="btn pill" data-mode="work">ä¸“æ³¨</button>
              <button class="btn pill" data-mode="short">çŸ­ä¼‘</button>
              <button class="btn pill" data-mode="long">é•¿ä¼‘</button>
              <span class="badge" id="cycleInfo">ç¬¬ 1 è½®</span>
            </div>
            <div class="screen">
              <div class="time" id="time">25:00</div>
              <div class="muted" id="modeLabel">ä¸“æ³¨æ¨¡å¼</div>
            </div>
            <div class="row">
              <button class="btn primary" id="startPause">å¼€å§‹</button>
              <button class="btn" id="skip">è·³è¿‡</button>
              <button class="btn ghost" id="reset">é‡ç½®</button>
            </div>
            <div class="row">
              <label class="badge">ä¸“æ³¨/çŸ­ä¼‘/é•¿ä¼‘(åˆ†)</label>
              <input id="cfgWork" type="number" min="5" step="5" value="25" style="width:90px">
              <input id="cfgShort" type="number" min="3" step="1" value="5" style="width:90px">
              <input id="cfgLong" type="number" min="10" step="5" value="15" style="width:90px">
              <label class="badge">æ¯å‡ è½®é•¿ä¼‘</label>
              <input id="cfgEvery" type="number" min="2" step="1" value="4" style="width:90px">
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="kpi" aria-label="å…³é”®æŒ‡æ ‡">
            <div class="card"><div class="muted">æœ¬å‘¨ç´¯è®¡(åˆ†)</div><div class="num" id="wkMin">0</div></div>
            <div class="card"><div class="muted">æœ¬æœˆç´¯è®¡(åˆ†)</div><div class="num" id="moMin">0</div></div>
            <div class="card"><div class="muted">è¿ç»­æ‰“å¡(å¤©)</div><div class="num" id="streak">0</div></div>
          </div>
        </div>
      </div>

      <div class="panel" id="todoPanel">
        <div class="hd">
          <strong>ä»Šæ—¥å¾…åŠ</strong>
          <div class="row">
            <span class="badge">æŒ‰å­¦ç§‘ç­›é€‰</span>
            <div id="filterBar" class="row"></div>
          </div>
        </div>
        <div class="bd">
          <div class="todo-header">
            <div class="muted">å»ºè®®ï¼šä¸º â€œè‹±è¯­äºŒ / æ”¿æ²» / ç”ŸåŒ– / åˆ†å­ç”Ÿç‰©å­¦ / å¾®ç”Ÿç‰©â€ å»ºç«‹é¢—ç²’åº¦é€‚ä¸­çš„ä»»åŠ¡ï¼Œä¼°æ—¶ä»¥ 25â€“50 åˆ†ä¸ºå®œã€‚</div>
            <div class="grow"></div>
            <button class="btn" id="tplBtn" title="ä¸€é”®ç”Ÿæˆæ¨¡æ¿ä»»åŠ¡">æ’å…¥æ¨¡æ¿</button>
            <button class="btn ghost" id="clearDone">æ¸…ç†å·²å®Œæˆ</button>
          </div>

          <div class="todo-inputs" style="margin-top:8px" aria-label="æ–°å¢ä»»åŠ¡">
            <input id="taskTitle" placeholder="ä»»åŠ¡å†…å®¹ï¼Œå¦‚ï¼šè‹±è¯­äºŒçœŸé¢˜é˜…è¯» 1 ç¯‡ + ç²¾è¯»" aria-label="ä»»åŠ¡å†…å®¹"/>
            <select id="taskSubject" aria-label="å­¦ç§‘">
              <option value="è‹±è¯­äºŒ">è‹±è¯­äºŒ</option>
              <option value="æ”¿æ²»">æ”¿æ²»</option>
              <option value="ç”ŸåŒ–">ç”ŸåŒ–</option>
              <option value="åˆ†å­ç”Ÿç‰©å­¦">åˆ†å­ç”Ÿç‰©å­¦</option>
              <option value="å¾®ç”Ÿç‰©">å¾®ç”Ÿç‰©</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <input id="taskDue" type="date" aria-label="æˆªæ­¢æ—¥æœŸ">
            <select id="taskPri" aria-label="ä¼˜å…ˆçº§">
              <option value="P2">å¸¸è§„</option>
              <option value="P1">ç´§æ€¥</option>
              <option value="P3">ä½</option>
            </select>
            <button id="addTask" class="btn primary">æ·»åŠ  (Enter)</button>
          </div>

          <div id="taskList" style="margin-top:10px" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="planPanel">
        <div class="hd">
          <strong>é˜¶æ®µå‘¨è®¡åˆ’</strong>
          <div class="row">
            <span class="badge" id="phaseLabel">é˜¶æ®µ</span>
            <button class="btn icon" id="wkPrev" title="ä¸Šä¸€å‘¨" aria-label="ä¸Šä¸€å‘¨">â—€</button>
            <span class="badge" id="wkLabel">ç¬¬ 1 å‘¨ Â· --/-- â€“ --/--</span>
            <button class="btn icon" id="wkNext" title="ä¸‹ä¸€å‘¨" aria-label="ä¸‹ä¸€å‘¨">â–¶</button>
            <button class="btn" id="pushWeek" title="æŠŠæœ¬å‘¨è®¡åˆ’ç”Ÿæˆåˆ°å¾…åŠ">ä¸‹å‘æœ¬å‘¨åˆ°å¾…åŠ</button>
            <button class="btn ghost" id="pushAll" title="ä¸€é”®ç”Ÿæˆ 19 å‘¨">ä¸€é”®ç”Ÿæˆ19å‘¨</button>
          </div>
        </div>
        <div class="bd">
          <ul id="wkGoals" class="wk-list"></ul>
          <div class="muted" style="margin-top:6px">æç¤ºï¼šç‚¹å‡»â€œä¸‹å‘æœ¬å‘¨åˆ°å¾…åŠâ€ä¼šæŠŠæœ¬å‘¨æ—¥å¸¸é…é¢ç”Ÿæˆå¸¦æˆªæ­¢æ—¥æœŸçš„ä»»åŠ¡ã€‚</div>
        </div>
      </div>

      <div class="panel" id="ttPanel">
        <div class="hd">
          <strong>æ—¶é—´è§„åˆ’è¡¨</strong>
          <span class="badge">æ¯æ—¥èŠ‚å¥ï¼š07:30â€“22:00</span>
        </div>
        <div class="bd">
          <div id="ttBox" class="tt-grid" aria-label="æ—¶é—´è§„åˆ’è¡¨"></div>
          <div class="muted" style="margin-top:6px">è¯´æ˜ï¼šæ­¤è¡¨ä¸ºé»˜è®¤å­¦ä¹ èŠ‚å¥ï¼Œå¯åœ¨ä»£ç é‡Œè°ƒæ•´ã€‚</div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="calendarPanel">
        <div class="hd">
          <strong>æ‰“å¡æ—¥å†</strong>
          <div class="row">
            <button class="btn icon" id="prevMonth" title="ä¸Šæœˆ" aria-label="ä¸Šä¸ªæœˆ">â—€</button>
            <span class="badge" id="ymLabel">--</span>
            <button class="btn icon" id="nextMonth" title="ä¸‹æœˆ" aria-label="ä¸‹ä¸ªæœˆ">â–¶</button>
            <span class="badge">æ ‡å‡†ï¼šå½“æ—¥ä¸“æ³¨åˆ†é’Ÿ â‰¥ ä»Šæ—¥ç›®æ ‡ï¼Œè§†ä¸ºè¾¾æ ‡</span>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:6px; justify-content:space-between">
            <div class="row" style="gap:10px">
              <span class="dow">ä¸€</span><span class="dow">äºŒ</span><span class="dow">ä¸‰</span>
              <span class="dow">å››</span><span class="dow">äº”</span><span class="dow">å…­</span><span class="dow">æ—¥</span>
            </div>
            <div class="row">
              <button id="markToday" class="btn">æ‰‹åŠ¨æ‰“å¡ä»Šå¤©</button>
            </div>
          </div>
          <div id="calendar" class="calendar" aria-label="æœˆå†"></div>
        </div>
      </div>

      <div class="panel" id="vocabPanel">
        <div class="hd"><strong>è¯æ±‡å¡ç‰‡</strong>
          <div class="row">
            <button class="btn" id="startQuiz">å¼€å§‹æµ‹éªŒ</button>
            <button class="btn ghost" id="shuffle">æ‰“ä¹±</button>
          </div>
        </div>
        <div class="bd vocab">
          <div class="row">
            <input id="vWord" placeholder="å•è¯ / æœ¯è¯­ (å¦‚: glycolysis)"/>
            <input id="vMean" placeholder="é‡Šä¹‰ (å¦‚: ç³–é…µè§£)"/>
            <button id="addVocab" class="btn primary">æ·»åŠ </button>
          </div>
          <div id="vCards" class="row" style="flex-wrap:wrap"></div>
          <div id="quizBox" class="card" hidden>
            <div class="word" id="qFront">â€”</div>
            <div class="mean" id="qBack" hidden>â€”</div>
            <div class="row" style="justify-content:center; margin-top:8px">
              <button class="btn" id="reveal">æ˜¾ç¤ºé‡Šä¹‰</button>
              <button class="btn" id="know" title="è®¤è¯†">è®¤è¯†</button>
              <button class="btn" id="dont">ä¸è®¤è¯†</button>
            </div>
            <div class="muted" id="qMeta" style="margin-top:6px">0 / 0</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="notesPanel">
        <div class="hd"><strong>éšæ‰‹ç¬”è®°</strong>
          <div class="toolbar">
            <button class="btn icon" data-cmd="bold" title="åŠ ç²—"><b>B</b></button>
            <button class="btn icon" data-cmd="italic" title="æ–œä½“"><i>I</i></button>
            <button class="btn icon" data-cmd="underline" title="ä¸‹åˆ’çº¿"><u>U</u></button>
            <button class="btn icon" id="h1Btn" title="ä¸€çº§æ ‡é¢˜">H1</button>
            <button class="btn" id="clearNotes" title="æ¸…ç©ºç¬”è®°">æ¸…ç©º</button>
          </div>
        </div>
        <div class="bd">
          <div id="editor" class="editor" contenteditable="true" aria-label="å¯ç¼–è¾‘ç¬”è®°åŒºåŸŸ"></div>
        </div>
      </div>

      <div class="panel" id="statsPanel">
        <div class="hd"><strong>å­¦ä¹ ç»Ÿè®¡</strong>
          <div class="row">
            <span class="badge">è¿‘ 14 å¤©ä¸“æ³¨åˆ†é’Ÿ</span>
            <span class="badge">å®Œæˆä»»åŠ¡è®¡æ•°</span>
          </div>
        </div>
        <div class="bd stats-grid">
          <canvas id="chartMin" aria-label="ä¸“æ³¨åˆ†é’ŸæŸ±çŠ¶å›¾"></canvas>
          <canvas id="chartTask" aria-label="å®Œæˆä»»åŠ¡æŸ±çŠ¶å›¾"></canvas>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="panel" id="linksPanel">
        <div class="hd"><strong>èµ„æ–™ä¸é“¾æ¥</strong>
          <div class="row">
            <input id="linkTitle" placeholder="åç§°ï¼Œå¦‚ï¼šç”ŸåŒ–æ€ç»´å¯¼å›¾ PDF" />
            <input id="linkUrl" placeholder="é“¾æ¥ï¼Œå¦‚ï¼šhttps://..." />
            <button id="addLink" class="btn primary">æ·»åŠ </button>
          </div>
        </div>
        <div class="bd" id="links"></div>
      </div>

      <div class="panel no-print" id="toolsPanel">
        <div class="hd"><strong>å·¥å…·ä¸æ•°æ®</strong></div>
        <div class="bd">
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" id="exportBtn">å¯¼å‡ºæ•°æ®(JSON)</button>
            <label class="btn ghost" for="importFile">å¯¼å…¥æ•°æ®</label>
            <input type="file" id="importFile" accept="application/json" hidden>
            <button class="btn" id="printBtn">æ‰“å°å­¦ä¹ æ—¥æŠ¥</button>
            <button class="btn danger" id="resetAll">æ¢å¤å‡ºå‚(å±é™©)</button>
          </div>
          <div class="muted" style="margin-top:6px">æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ <code>localStorage</code> ä¸­ï¼›å¦‚éœ€å¤šè®¾å¤‡åŒæ­¥ï¼Œå³ä¸Šè§’ç™»å½•åå°†è‡ªåŠ¨åŒæ­¥è‡³äº‘ç«¯ã€‚</div>
        </div>
      </div>
    </div>
  </main>

  <dialog id="onboard">
    <form method="dialog" style="min-width: min(520px, 90vw);">
      <h3>é¦–æ¬¡è®¾ç½®</h3>
      <p class="muted">ä»¥ä¸‹è®¾ç½®å¯éšæ—¶åœ¨é¡µé¢ä¸­ä¿®æ”¹ã€‚</p>
      <div class="row" style="gap:10px; align-items:center">
        <label>åˆè¯•æ—¥æœŸï¼š</label>
        <input type="date" id="obDate">
      </div>
      <div class="row" style="gap:10px; align-items:center; margin-top:8px">
        <label>æ¯æ—¥ç›®æ ‡(åˆ†é’Ÿ)ï¼š</label>
        <input type="number" id="obGoal" min="30" step="5" value="180" style="width:120px">
      </div>
      <div style="margin-top:12px">
        <details>
          <summary>ä¸€é”®æ’å…¥ç¤ºä¾‹ä»»åŠ¡ä¸è¯æ±‡</summary>
          <div class="muted">å°†ä¸ºâ€œè‹±è¯­äºŒ / æ”¿æ²» / ç”ŸåŒ– / åˆ†å­ç”Ÿç‰©å­¦ / å¾®ç”Ÿç‰©â€æ’å…¥è‹¥å¹²ç¤ºä¾‹ä»»åŠ¡ï¼›è¯æ±‡å¡ç‰‡æ’å…¥ 6 æ¡ç¤ºä¾‹ã€‚</div>
          <label class="row" style="margin-top:6px"><input type="checkbox" id="obSeed" checked> æ’å…¥ç¤ºä¾‹æ•°æ®</label>
        </details>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:14px">
        <button class="btn ghost" value="cancel">è·³è¿‡</button>
        <button class="btn primary" value="ok">å®Œæˆ</button>
      </div>
    </form>
  </dialog>

  <script>
  // ===== åŸºç¡€å·¥å…· =====
  const KEYP = 'ke_bio_v1_'; // â† å…¨æ–°å‰ç¼€ï¼šä¸ä¼šè¯»å–æ—§ç‰ˆæ•°æ®
  const store = {
    get(k, def){ try{ const v = localStorage.getItem(KEYP+k); return v ? JSON.parse(v) : (def ?? null)}catch{ return def ?? null } },
    set(k, v){ localStorage.setItem(KEYP+k, JSON.stringify(v)); },
    del(k){ localStorage.removeItem(KEYP+k); },
    all(){ const o={}; try{ for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); if(k && k.startsWith(KEYP)){ try{o[k]=JSON.parse(localStorage.getItem(k))}catch{} } } }catch{} return o; }
  };
  window.__KE_PREFIX__ = KEYP;

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt2 = n => String(n).padStart(2,'0');
  const todayKey = (d=new Date()) => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const ymd = d => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;
  const monday = d => { const t=new Date(d); const w=(t.getDay()+6)%7; t.setDate(t.getDate()-w); t.setHours(0,0,0,0); return t; };
  const addDays = (d, n) => { const t=new Date(d); t.setDate(t.getDate()+n); return t; };

  // ä¸»é¢˜ & æ—¶é’Ÿ
  const themeBtn = $('#themeBtn');
  function applyTheme(){ document.documentElement.setAttribute('data-theme', store.get('theme','dark')); }
  if(store.get('theme', null)===null){ store.set('theme','dark'); }
  themeBtn.onclick = () => { const t = store.get('theme','dark')==='dark'?'light':'dark'; store.set('theme', t); applyTheme(); };
  applyTheme();
  function tickNow(){ const d=new Date(); const s=`${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())} ${fmt2(d.getHours())}:${fmt2(d.getMinutes())}:${fmt2(d.getSeconds())}`; $('#now').textContent=s; }
  setInterval(tickNow, 1000); tickNow();

  // â€”â€” é»˜è®¤æ—¶é—´è¡¨ / é˜¶æ®µ
  const defaultTT = [
    {time:'07:30â€“08:00', title:'è‹±è¯­çƒ­èº«ï¼ˆè¯æ±‡/æœ—è¯»ï¼‰'},
    {time:'08:00â€“09:50', title:'ç”ŸåŒ– ç²¾è¯» + ä¾‹é¢˜ï¼ˆç•ªèŒ„ 50/10 Ã—2ï¼‰'},
    {time:'10:00â€“11:50', title:'è‹±è¯­äºŒ é•¿éš¾å¥/é˜…è¯»ï¼ˆåˆ†é¡¹ï¼‰'},
    {time:'12:00â€“13:20', title:'åˆé¤ + ä¼‘æ¯20min'},
    {time:'13:30â€“15:20', title:'åˆ†å­ç”Ÿç‰©å­¦ ç²¾è¯» + é¢˜ç›®'},
    {time:'15:30â€“16:20', title:'æ”¿æ²» 1000é¢˜ é€‰æ‹©è®­ç»ƒï¼ˆ40â€“50é¢˜ï¼‰'},
    {time:'16:30â€“17:15', title:'å¾®ç”Ÿç‰© è®°å¿†/æ¡†æ¶å¤ç›˜'},
    {time:'17:45â€“18:15', title:'æ™šé¤'},
    {time:'19:00â€“20:20', title:'è‹±è¯­äºŒ çœŸé¢˜/ç¿»è¯‘/ä½œæ–‡'},
    {time:'20:30â€“21:20', title:'ä¸“ä¸šè¯¾è½®èƒŒï¼ˆç”ŸåŒ–/åˆ†å­/å¾®ç”Ÿï¼‰'},
    {time:'21:20â€“22:00', title:'å¤ç›˜å¡ï¼ˆé”™é¢˜3æ¡/æ”¶è·3æ¡/æ˜æ—¥3äº‹ï¼‰'}
  ];
  const phases = [
    {name:'é˜¶æ®µ1ï½œåŸºç¡€å¤¯å®', weeks:4, goals:{
      eng:'é•¿éš¾å¥ 20å¥/å‘¨ï¼›é˜…è¯» 6ç¯‡/å‘¨ï¼›ç¿»è¯‘æ®µè½ 2 æ®µ/å‘¨',
      pol:'ã€Š1000é¢˜ã€‹ç¬¬ä¸€éï¼šé€‰æ‹©é¢˜ 50é¢˜/æ—¥ Ã—5å¤©',
      bio:'ç”ŸåŒ–ï¼šä»£è°¢/é…¶/è›‹ç™½è´¨ç»“æ„é€šè¯»+é…å¥—é¢˜',
      mol:'åˆ†å­ï¼šDNA å¤åˆ¶/è½¬å½•/ç¿»è¯‘æ¡†æ¶ä¸æ ¸å¿ƒæœºåˆ¶',
      mic:'å¾®ç”Ÿï¼šç»†èŒ/çœŸèŒ/ç—…æ¯’åŸºç¡€ + å¸¸è§èŒå±è¯†è®°'
    }},
    {name:'é˜¶æ®µ2ï½œäºŒåˆ·ä¸ä¸“é¢˜çªç ´', weeks:4, goals:{
      eng:'åˆ†é¡¹å¼ºåŒ–ï¼ˆé˜…è¯»/ç¿»è¯‘/å®Œå½¢/æ–°é¢˜å‹ï¼‰ï¼›ä½œæ–‡ç´ æ 2 ç¯‡/å‘¨',
      pol:'ã€Š1000é¢˜ã€‹ç¬¬äºŒé + ä¸»è§‚é¢˜æ¡†æ¶',
      bio:'ç”ŸåŒ–ä¸“é¢˜ï¼šç³–ä»£è°¢/è„‚ä»£è°¢/æ°¨åŸºé…¸ä»£è°¢æ•´åˆ',
      mol:'åˆ†å­ï¼šåŸºå› è¡¨è¾¾è°ƒæ§/åŸºå› å·¥ç¨‹ä¸è½½ä½“',
      mic:'å¾®ç”Ÿï¼šåŸ¹å…»/æŸ“è‰²/ç­èŒæ¶ˆæ¯’/æŠ—èŒè¯åŸºç¡€'
    }},
    {name:'é˜¶æ®µ3ï½œçœŸé¢˜ä¸»æ”»', weeks:4, goals:{
      eng:'çœŸé¢˜æ•´å¥— æ¯å‘¨ 1â€“2 å¥—ï¼›ä½œæ–‡ A/B å„ 1 ç¯‡',
      pol:'é€‰æ‹©é¢˜ç¬¬ä¸‰é + æ—¶æ”¿å¼€å§‹æ•´ç†',
      bio:'ç”ŸåŒ–çœŸé¢˜/æ¨¡æ‹Ÿé¢˜ï¼š3 å¤©ä¸€å¥— + 2 å¤©å‰–æ',
      mol:'åˆ†å­ç»¼åˆå¤§é¢˜ï¼šæ¯å‘¨ 1â€“2 æ¬¡ä»¿çœŸä¹¦å†™',
      mic:'å¾®ç”Ÿé«˜é¢‘åè¯è§£é‡Š/ç®€ç­”æ»šåŠ¨èƒŒè¯µ'
    }},
    {name:'é˜¶æ®µ4ï½œæ¨¡æ‹Ÿæ‹”é«˜', weeks:4, goals:{
      eng:'å‘¨æœ«å…¨çœŸï¼›å·¥ä½œæ—¥çº é”™ + è¯­æ³•/ç¿»è¯‘è–„å¼±ç¯',
      pol:'ä¸»è§‚é¢˜æ¨¡æ¿å®šç¨¿ + æ—¶æ”¿å¼ºåŒ–',
      bio:'ç”ŸåŒ–é”™é¢˜æ¸…é›¶ + é«˜é¢‘æ˜“æ··æ¢³ç†',
      mol:'åˆ†å­è¦ç‚¹å¡ç‰‡åŒ– + å›¾è¡¨è¿‡ä¸€é',
      mic:'å¾®ç”Ÿæ¡ˆä¾‹/å®éªŒè®¾è®¡é¢˜è®­ç»ƒ'
    }},
    {name:'é˜¶æ®µ5ï½œå†²åˆºæŸ¥ç¼º', weeks:3, goals:{
      eng:'ä½œæ–‡æ¯æ—¥å¿«å†™ 1 ç¯‡ï¼›å®Œå½¢/æ–°é¢˜å‹è½»ç»´æŠ¤',
      pol:'èƒŒè¯µæ¯æ—¥ä¸‰éï¼ˆæ—©/åˆ/æ™šï¼‰ï¼›é¢„æµ‹é¢˜å›çœ‹',
      bio:'ç”ŸåŒ–/åˆ†å­/å¾®ç”Ÿ é«˜é¢‘è€ƒç‚¹æ¯æ—¥æ»šåŠ¨èƒŒ',
      mol:'é”™é¢˜äºŒæ¬¡è®¢æ­£ï¼ˆæŒ‰é”™è¯¯ç±»å‹å½’æ¡£ï¼‰',
      mic:'åè¯è§£é‡Š/ç®€ç­”é€ŸèƒŒ+é»˜å†™'
    }}
  ];

  // â€”â€” é¦–æ¬¡åŠ è½½ï¼šå†™å…¥é»˜è®¤æ•°æ®ï¼ˆä¸ä¼šè¦†ç›–å·²æœ‰æ•°æ®ï¼‰
  function seedTasksBio(){
    const d = ymd(new Date());
    return [
      {id:crypto.randomUUID(), title:'çœŸé¢˜é˜…è¯» 1 ç¯‡ + ç²¾è¯»ï¼ˆæ ‡ç”Ÿè¯/ç»“æ„ï¼‰', subject:'è‹±è¯­äºŒ', due:d, pri:'P1', est:50, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'é•¿éš¾å¥ 10 å¥ + ç¿»è¯‘ 2 æ®µ', subject:'è‹±è¯­äºŒ', due:d, pri:'P2', est:45, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'ã€Š1000é¢˜ã€‹é€‰æ‹© 40â€“50 é¢˜ï¼ˆé©¬åŸ/æ€ä¿®ä»»ä¸€ï¼‰', subject:'æ”¿æ²»', due:d, pri:'P2', est:40, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'ç”ŸåŒ– Â· ç³–ä»£è°¢é€šè·¯æ¢³ç† + ä¾‹é¢˜ 3 é¢˜', subject:'ç”ŸåŒ–', due:d, pri:'P1', est:90, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'åˆ†å­ç”Ÿç‰©å­¦ Â· DNA å¤åˆ¶æœºåˆ¶è¦ç‚¹ + ä¾‹é¢˜ 2 é¢˜', subject:'åˆ†å­ç”Ÿç‰©å­¦', due:d, pri:'P2', est:70, done:false, createdAt:Date.now()},
      {id:crypto.randomUUID(), title:'å¾®ç”Ÿç‰© Â· ç»†èŒå½¢æ€/åŸ¹å…»åŸºè®°å¿†ï¼ˆ30minï¼‰', subject:'å¾®ç”Ÿç‰©', due:d, pri:'P3', est:30, done:false, createdAt:Date.now()}
    ];
  }

  function ensureDefaults(){
    if(!store.get('examDate', null)) store.set('examDate', '2025-12-20');
    if(store.get('goalMin', null)==null) store.set('goalMin', 180);
    if(!store.get('timetable', null)) store.set('timetable', defaultTT);

    if(!store.get('phaseWeeks', null)){
      const weeks = [];
      let cur = monday(new Date()); // ä»æœ¬å‘¨ä¸€å¼€å§‹é¡ºæ’ 19 å‘¨
      phases.forEach(ph=>{
        for(let i=0;i<ph.weeks;i++){
          const s = new Date(cur);
          const e = addDays(cur, 6);
          weeks.push({idx: weeks.length+1, phase: ph.name, start: ymd(s), end: ymd(e), goals: ph.goals});
          cur = addDays(cur, 7);
        }
      });
      store.set('phaseWeeks', weeks);
      store.set('curWeekIdx', 1);
    }

    if(store.get('tasks', null)===null){
      store.set('tasks', seedTasksBio()); // â† ç›´æ¥é¢„ç½®æ–°å­¦ç§‘ä»»åŠ¡
    }
  }
  ensureDefaults();

  // å€’è®¡æ—¶
  const examDateInput = $('#examDate');
  function readExamDate(){ const s = store.get('examDate', null); if(s) examDateInput.value = s; }
  function saveExamDate(){ const v = examDateInput.value; if(v) store.set('examDate', v); }
  examDateInput.addEventListener('change', ()=>{ saveExamDate(); updateCountdown(); buildCalendar(); });
  function updateCountdown(){
    const s = examDateInput.value; const dLeftEl = $('#dLeft');
    if(!s){ dLeftEl.textContent = '--'; return; }
    const tgt = new Date(s+'T00:00:00'); const now = new Date();
    const ms = tgt - now; const days = Math.ceil(ms / 86400000);
    dLeftEl.textContent = days >= 0 ? days : 0;
  }
  readExamDate(); updateCountdown(); setInterval(updateCountdown, 60000);

  // ç•ªèŒ„é’Ÿ
  const cfg = { work: store.get('cfg_work',25), short: store.get('cfg_short',5), long: store.get('cfg_long',15), every: store.get('cfg_every',4) };
  $('#cfgWork').value = cfg.work; $('#cfgShort').value = cfg.short; $('#cfgLong').value = cfg.long; $('#cfgEvery').value = cfg.every;
  ['cfgWork','cfgShort','cfgLong','cfgEvery'].forEach(id=>{
    $('#'+id).addEventListener('change',()=>{
      cfg.work=+$('#cfgWork').value; cfg.short=+$('#cfgShort').value; cfg.long=+$('#cfgLong').value; cfg.every=+$('#cfgEvery').value;
      store.set('cfg_work',cfg.work); store.set('cfg_short',cfg.short); store.set('cfg_long',cfg.long); store.set('cfg_every',cfg.every);
      if(state.mode==='work') state.left=cfg.work*60; renderPomodoro();
    });
  });
  const state = { mode: 'work', left: cfg.work*60, running: false, timer: null, cycle: store.get('cycle',1) };
  function setMode(m){ state.mode=m; if(m==='work') state.left=cfg.work*60; if(m==='short') state.left=cfg.short*60; if(m==='long') state.left=cfg.long*60; renderPomodoro(); }
  function nextMode(){ if(state.mode==='work'){ if(state.cycle % cfg.every === 0){ setMode('long'); } else { setMode('short'); } } else { state.cycle++; store.set('cycle', state.cycle); setMode('work'); } }
  function renderPomodoro(){
    $('#time').textContent = `${fmt2(Math.floor(state.left/60))}:${fmt2(Math.floor(state.left%60))}`;
    $('#modeLabel').textContent = state.mode==='work'?'ä¸“æ³¨æ¨¡å¼':(state.mode==='short'?'çŸ­ä¼‘æ¨¡å¼':'é•¿ä¼‘æ¨¡å¼');
    $('#cycleInfo').textContent = `ç¬¬ ${state.cycle} è½®`;
    $$('.modes .btn').forEach(b=>{ b.classList.toggle('active', b.dataset.mode===state.mode); });
  }
  function tick(){ if(!state.running) return; state.left--; if(state.left<=0){ completeSession(); nextMode(); } renderPomodoro(); }
  function start(){ if(state.running) return; state.running=true; state.timer=setInterval(tick, 1000); $('#startPause').textContent='æš‚åœ'; }
  function pause(){ state.running=false; clearInterval(state.timer); $('#startPause').textContent='å¼€å§‹'; }
  function reset(){ pause(); setMode(state.mode); }
  $('#startPause').onclick=()=>{ state.running?pause():start(); };
  $('#skip').onclick=()=>{ nextMode(); reset(); };
  $('#reset').onclick=()=>{ reset(); };
  function logToday(min, pom=1){
    const key = 'log_'+todayKey();
    const o = store.get(key,{min:0,pom:0, tasks:0});
    o.min += min; o.pom += pom; store.set(key,o);
    updateTodayProgress(); updateKPIs(); drawCharts(); updateGoalBadge(); markCalendarAuto();
  }
  function completeSession(){ if(state.mode==='work'){ logToday(cfg.work,1); } }

  function getAggregates(rangeDays=14){
    const arr=[]; const today=new Date();
    for(let i=rangeDays-1;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); const k='log_'+todayKey(d); const o=store.get(k,{min:0,pom:0,tasks:0}); arr.push({date:todayKey(d),...o}); }
    return arr;
  }
  function updateKPIs(){
    const now=new Date(); const dow=(now.getDay()+6)%7; // Mon=0
    const wkStart=new Date(now); wkStart.setDate(now.getDate()-dow);
    let wk=0, mo=0; for(let i=0;i<31;i++){ const d=new Date(now); d.setDate(now.getDate()-i); const k='log_'+todayKey(d); const o=store.get(k,{min:0}); if(d>=wkStart) wk+=o.min; if(d.getMonth()===now.getMonth()) mo+=o.min; }
    $('#wkMin').textContent=wk; $('#moMin').textContent=mo;
    let streak=0; for(let i=0;i<999;i++){ const d=new Date(now); d.setDate(now.getDate()-i); const k='log_'+todayKey(d); const o=store.get(k,null); const goal=+($('#goalMin').value||180); if(o && o.min>=goal) streak++; else break; }
    $('#streak').textContent=streak;
  }
  const goalMin = $('#goalMin'); goalMin.addEventListener('change',()=>{ store.set('goalMin', +goalMin.value); updateGoalBadge(); buildCalendar(); updateKPIs(); }); goalMin.value = store.get('goalMin', 180);
  function updateTodayProgress(){ const o=store.get('log_'+todayKey(),{min:0,pom:0,tasks:0}); $('#todayProgress').textContent=`ä»Šæ—¥ä¸“æ³¨ ${o.min} åˆ†é’Ÿ Â· ${o.pom} ä¸ªç•ªèŒ„ Â· ${o.tasks||0} ä¸ªä»»åŠ¡`; }
  function updateGoalBadge(){ const goal=+goalMin.value; const o=store.get('log_'+todayKey(),{min:0}); const hit = o.min>=goal; const b=$('#goalHit'); b.textContent = hit? 'å·²è¾¾æˆ' : 'æœªè¾¾æˆ'; b.style.background = hit? 'linear-gradient(135deg, var(--ok), #90e6c2)' : 'var(--panel-hi)'; }
  updateTodayProgress(); updateGoalBadge(); updateKPIs();

  // å¾…åŠ
  let tasks = store.get('tasks', []);
  const subjects = ['è‹±è¯­äºŒ','æ”¿æ²»','ç”ŸåŒ–','åˆ†å­ç”Ÿç‰©å­¦','å¾®ç”Ÿç‰©','å…¶ä»–'];
  const filterBar = $('#filterBar');
  let curFilter = store.get('filter','å…¨éƒ¨');
  function renderFilters(){
    filterBar.innerHTML='';
    ['å…¨éƒ¨',...subjects].forEach(s=>{
      const b=document.createElement('button'); b.className='btn pill'+(curFilter===s?' active':''); b.textContent=s; b.onclick=()=>{ curFilter=s; store.set('filter',s); renderTasks(); renderFilters(); };
      filterBar.appendChild(b);
    })
  }
  renderFilters();

  function addTask(t){ tasks.push(t); store.set('tasks', tasks); renderTasks(); }
  function removeTask(id){ tasks = tasks.filter(x=>x.id!==id); store.set('tasks', tasks); renderTasks(); }
  function updateTask(id,patch){ const i=tasks.findIndex(x=>x.id===id); if(i>-1){ tasks[i]=Object.assign({},tasks[i],patch); store.set('tasks', tasks); renderTasks(); } }
  function renderTasks(){
    const box = $('#taskList'); box.innerHTML='';
    let arr = tasks.slice().sort((a,b)=>a.done-b.done || (a.pri>b.pri?1:-1) || (a.due||'').localeCompare(b.due||''));
    if(curFilter!=='å…¨éƒ¨') arr = arr.filter(t=>t.subject===curFilter);
    arr.forEach(t=> box.appendChild(renderTaskItem(t)));
  }
  function renderTaskItem(t){
    const el=document.createElement('div'); el.className='task'+(t.done?' done':''); el.draggable=true; el.dataset.id=t.id;
    el.innerHTML=`<input type="checkbox" ${t.done?'checked':''} aria-label="å®Œæˆä»»åŠ¡">
      <div>
        <div class="title">${escapeHtml(t.title)} <span class="tag">${t.subject}</span></div>
        <div class="meta">ä¼˜å…ˆçº§: ${t.pri} ${t.due?(' Â· æˆªæ­¢: '+t.due):''} Â· é¢„è®¡: ${t.est||25}åˆ†</div>
      </div>
      <div class="row">
        <button class="btn icon" data-act="inc">ï¼‹5åˆ†</button>
        <button class="btn icon" data-act="edit">âœ</button>
        <button class="btn icon" data-act="del">ğŸ—‘</button>
      </div>`;
    el.querySelector('input').onchange = (e)=>{ updateTask(t.id,{done:e.target.checked}); if(e.target.checked){
        const key='log_'+todayKey(); const lg = store.get(key,{min:0,pom:0,tasks:0}); lg.tasks=(lg.tasks||0)+1; store.set(key,lg); updateTodayProgress(); drawCharts(); updateGoalBadge(); updateKPIs(); buildCalendar();
    }}; 
    el.querySelector('[data-act="del"]').onclick=()=> removeTask(t.id);
    el.querySelector('[data-act="inc"]').onclick=()=> { updateTask(t.id,{est:(t.est||25)+5}); };
    el.querySelector('[data-act="edit"]').onclick=()=> editTask(t);
    el.addEventListener('dragstart',()=>{ el.classList.add('dragging'); });
    el.addEventListener('dragend',()=>{ el.classList.remove('dragging'); saveOrder(); });
    el.addEventListener('dragover',(e)=>{ e.preventDefault(); const dragging = document.querySelector('.task.dragging'); if(!dragging||dragging===el) return; const box=el.parentElement; const items=[...box.children]; const draggingIdx=items.indexOf(dragging); const elIdx=items.indexOf(el); if(draggingIdx<elIdx){ box.insertBefore(dragging, el.nextSibling);} else { box.insertBefore(dragging, el);} });
    return el;
  }
  function saveOrder(){ const ids=[...$('#taskList').children].map(n=>n.dataset.id); tasks.sort((a,b)=> ids.indexOf(a.id)-ids.indexOf(b.id)); store.set('tasks', tasks); }
  function editTask(t){ const nv = prompt('ä¿®æ”¹ä»»åŠ¡å†…å®¹', t.title); if(nv!==null){ updateTask(t.id,{title:nv}); }}
  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  $('#addTask').onclick=()=> doAdd();
  function doAdd(){
    const title=$('#taskTitle').value.trim(); if(!title){ $('#taskTitle').focus(); return; }
    const subject=$('#taskSubject').value; const due=$('#taskDue').value||null; const pri=$('#taskPri').value; const est=25;
    addTask({id:crypto.randomUUID(), title, subject, due, pri, est, done:false, createdAt:Date.now()});
    $('#taskTitle').value=''; $('#taskTitle').focus();
  }
  $('#taskTitle').addEventListener('keydown',e=>{ if(e.key==='Enter'){ doAdd(); }});
  $('#clearDone').onclick=()=>{ if(confirm('ç¡®è®¤åˆ é™¤æ‰€æœ‰å·²å®Œæˆä»»åŠ¡ï¼Ÿ')){ tasks=tasks.filter(t=>!t.done); store.set('tasks',tasks); renderTasks(); }}
  $('#tplBtn').onclick=()=> insertTemplates();

  function insertTemplates(){
    const tpl=[
      {s:'è‹±è¯­äºŒ', t:'çœŸé¢˜é˜…è¯» 1 ç¯‡ + ç²¾è¯»ï¼ˆæ ‡ç”Ÿè¯/ç»“æ„ï¼‰'},
      {s:'è‹±è¯­äºŒ', t:'é•¿éš¾å¥ 10 å¥ + ç¿»è¯‘ 2 æ®µ'},
      {s:'æ”¿æ²»', t:'1000é¢˜ Â· é©¬åŸ/æ€ä¿® 40â€“50 é¢˜'},
      {s:'ç”ŸåŒ–', t:'ä»£è°¢æ€»è§ˆæ¡†æ¶å›¾ + ä¾‹é¢˜ 3 é¢˜'},
      {s:'åˆ†å­ç”Ÿç‰©å­¦', t:'åŸºå› è¡¨è¾¾è°ƒæ§è¦ç‚¹ + ä¾‹é¢˜ 2 é¢˜'},
      {s:'å¾®ç”Ÿç‰©', t:'ç­èŒ/æ¶ˆæ¯’æ–¹æ³•ä¸åŸç†ï¼ˆ30minï¼‰'}
    ];
    tpl.forEach(x=> addTask({id:crypto.randomUUID(), title:x.t, subject:x.s, due:null, pri:'P2', est:25, done:false, createdAt:Date.now()}));
  }
  renderTasks();

  // æ‰“å¡æ—¥å†
  let curYM = (d=>({y:d.getFullYear(), m:d.getMonth()+1}))(new Date());
  function buildCalendar(){
    const y=curYM.y, m=curYM.m; $('#ymLabel').textContent=`${y}å¹´${m}æœˆ`;
    const box=$('#calendar'); box.innerHTML='';
    const first=new Date(y, m-1, 1); const startDow=(first.getDay()+6)%7;
    const days=new Date(y, m, 0).getDate();
    for(let i=0;i<startDow;i++){ const ph=document.createElement('div'); box.appendChild(ph); }
    for(let d=1; d<=days; d++){
      const el=document.createElement('div'); el.className='day';
      const dateStr=`${y}-${fmt2(m)}-${fmt2(d)}`;
      const lg=store.get('log_'+dateStr,null); const goal=+($('#goalMin').value||180);
      const good = lg && (lg.min||0) >= goal; const bad = lg && (lg.min||0) > 0 && (lg.min||0) < goal;
      if(good) el.classList.add('good'); if(bad) el.classList.add('bad');
      el.innerHTML=`<div class="d">${d}</div><div class="dot"></div>`;
      el.title = `${dateStr}ï¼šä¸“æ³¨ ${(lg?.min||0)} åˆ†é’Ÿ Â· ç•ªèŒ„ ${(lg?.pom||0)} Â· ä»»åŠ¡ ${(lg?.tasks||0)}`;
      el.onclick=()=>{ const o = store.get('log_'+dateStr,{min:0,pom:0,tasks:0}); const goal=+($('#goalMin').value||180); const newMin = (o.min>=goal)?0:goal; o.min=newMin; store.set('log_'+dateStr,o); if(dateStr===todayKey()) { updateGoalBadge(); updateTodayProgress(); updateKPIs(); } buildCalendar(); drawCharts(); };
      box.appendChild(el);
    }
  }
  function markCalendarAuto(){ buildCalendar(); }
  $('#prevMonth').onclick=()=>{ const d=new Date(curYM.y,curYM.m-2,1); curYM={y:d.getFullYear(), m:d.getMonth()+1}; buildCalendar(); };
  $('#nextMonth').onclick=()=>{ const d=new Date(curYM.y,curYM.m,1); curYM={y:d.getFullYear(), m:d.getMonth()+1}; buildCalendar(); };
  $('#markToday').onclick=()=>{ const t=todayKey(); const o=store.get('log_'+t,{min:0,pom:0,tasks:0}); const g=+($('#goalMin').value||180); o.min=Math.max(o.min, g); store.set('log_'+t,o); updateGoalBadge(); updateTodayProgress(); updateKPIs(); buildCalendar(); };
  buildCalendar();

  // ç¬”è®°
  const editor=$('#editor'); editor.innerHTML = store.get('notes','');
  editor.addEventListener('input',()=> store.set('notes', editor.innerHTML));
  $$('.toolbar [data-cmd]').forEach(b=> b.onclick=()=> document.execCommand(b.dataset.cmd,false,null));
  $('#h1Btn').onclick=()=> document.execCommand('formatBlock', false, 'H2');
  $('#clearNotes').onclick=()=>{ if(confirm('æ˜¯å¦æ¸…ç©ºç¬”è®°ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')){ editor.innerHTML=''; store.set('notes',''); }}

  // è¯æ±‡
  let vocabs = store.get('vocabs', []);
  function saveVocabs(){ store.set('vocabs', vocabs); renderCards(); }
  function addCard(w,m){ vocabs.push({id:crypto.randomUUID(), w, m, ef:2.5, due: Date.now() }); saveVocabs(); }
  $('#addVocab').onclick=()=>{ const w=$('#vWord').value.trim(); const m=$('#vMean').value.trim(); if(!w||!m) return; addCard(w,m); $('#vWord').value=''; $('#vMean').value=''; };
  $('#shuffle').onclick=()=>{ vocabs.sort(()=>Math.random()-.5); saveVocabs(); };
  function renderCards(){ const box=$('#vCards'); box.innerHTML=''; vocabs.forEach(v=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="word">${escapeHtml(v.w)}</div><div class="mean">${escapeHtml(v.m)}</div><div class="row" style="justify-content:center; margin-top:6px"><button class="btn icon" data-act="del">ğŸ—‘</button></div>`; c.querySelector('[data-act="del"]').onclick=()=>{ vocabs=vocabs.filter(x=>x.id!==v.id); saveVocabs(); }; box.appendChild(c); }); }
  renderCards();
  let quizQ=[], qi=0, showBack=false;
  function startQuiz(){ quizQ = vocabs.slice().filter(v=> v.due <= Date.now()).sort(()=>Math.random()-.5); if(quizQ.length===0) quizQ=vocabs.slice().sort(()=>Math.random()-.5); qi=0; showBack=false; $('#quizBox').hidden=false; nextQ(); }
  function nextQ(){ if(quizQ.length===0){ $('#quizBox').hidden=true; return; } const v=quizQ[qi%quizQ.length]; $('#qFront').textContent=v.w; $('#qBack').textContent=v.m; $('#qBack').hidden=true; $('#qMeta').textContent=`${(qi%quizQ.length)+1} / ${quizQ.length}`; showBack=false; }
  $('#startQuiz').onclick=()=> startQuiz();
  $('#reveal').onclick=()=>{ $('#qBack').hidden = !showBack; showBack = !showBack; };
  $('#know').onclick=()=> score(5);
  $('#dont').onclick=()=> score(2);
  function score(q){ const v=quizQ[qi%quizQ.length];
    const addMs = (q>=4) ? (86400000 * (2 + Math.random()*2)) : (600000 * (1 + Math.random()*5));
    v.due = Date.now() + addMs; saveVocabs(); qi++; if(qi>=quizQ.length) { qi=0; quizQ=quizQ.filter(x=> x.due<=Date.now()); if(quizQ.length===0){ $('#quizBox').hidden=true; return; } }
    nextQ();
  }

  // ç»Ÿè®¡å›¾
  function drawBar(canvasId, data, labelGetter, valueGetter){
    const cvs=$(canvasId); if(!cvs) return; const ctx=cvs.getContext('2d'); if(!ctx) return; const DPR=window.devicePixelRatio||1; const W=cvs.clientWidth*DPR, H=cvs.clientHeight*DPR; cvs.width=W; cvs.height=H; ctx.clearRect(0,0,W,H);
    const pad=20*DPR; const innerW=W-pad*2; const innerH=H-pad*2; ctx.font = 12*DPR+'px '+getComputedStyle(document.body).fontFamily; ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
    const max = Math.max(1, ...data.map(valueGetter));
    const n=data.length; const barW=innerW/n*0.72; const gap=(innerW/n - barW);
    ctx.globalAlpha=.5; ctx.fillRect(pad, pad+innerH, innerW, 1); ctx.globalAlpha=1;
    data.forEach((d,i)=>{
      const v=valueGetter(d); const h= v/max * (innerH-10*DPR); const x=pad + i*(barW+gap) + gap/2; const y=pad+innerH - h;
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--brand'); ctx.fillRect(x, y, barW, h);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text'); ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(String(v), x+barW/2, y-2*DPR);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted'); ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText(labelGetter(d), x+barW/2, pad+innerH + 12*DPR);
    });
  }
  function drawCharts(){
    const agg=getAggregates(14);
    drawBar('#chartMin', agg, d=>d.date.slice(5), d=>d.min);
    drawBar('#chartTask', agg, d=>d.date.slice(5), d=>d.tasks||0);
  }
  window.addEventListener('resize', drawCharts); drawCharts();

  // é“¾æ¥
  let links = store.get('links', []);
  function renderLinks(){ const box=$('#links'); box.innerHTML=''; links.forEach(l=>{ const a=document.createElement('div'); a.className='task'; a.innerHTML=`<div style="width:10px; height:10px; border-radius:50%; background:var(--brand)"></div>
      <div><div class="title"><a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">${escapeHtml(l.title)}</a></div>
      <div class="meta">${escapeHtml(l.url)}</div></div>
      <div class="row"><button class="btn icon" data-act="del">ğŸ—‘</button></div>`; a.querySelector('[data-act="del"]').onclick=()=>{ links=links.filter(x=>x.id!==l.id); store.set('links',links); renderLinks(); }; box.appendChild(a); }); }
  renderLinks();
  $('#addLink').onclick=()=>{ const t=$('#linkTitle').value.trim(); const u=$('#linkUrl').value.trim(); if(!t||!u) return; links.push({id:crypto.randomUUID(), title:t, url:u}); store.set('links',links); renderLinks(); $('#linkTitle').value=''; $('#linkUrl').value=''; };

  // é˜¶æ®µå‘¨è®¡åˆ’ & æ—¶é—´è¡¨
  function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }
  function cnRange(a,b){ const A=parseYMD(a), B=parseYMD(b); return `${A.getMonth()+1}/${A.getDate()}â€“${B.getMonth()+1}/${B.getDate()}`; }
  function renderWeekPlan(){
    const ws = store.get('phaseWeeks', []);
    if(!ws.length) return;
    let idx = clamp(store.get('curWeekIdx',1), 1, ws.length);
    store.set('curWeekIdx', idx);
    const w = ws[idx-1];
    $('#phaseLabel').textContent = w.phase;
    $('#wkLabel').textContent = `ç¬¬ ${w.idx} å‘¨ Â· ${cnRange(w.start, w.end)}`;
    const g = w.goals;
    $('#wkGoals').innerHTML = [
      `<li><b>è‹±è¯­äºŒ</b>ï¼š${g.eng}</li>`,
      `<li><b>æ”¿æ²»</b>ï¼š${g.pol}</li>`,
      `<li><b>ç”ŸåŒ–</b>ï¼š${g.bio}</li>`,
      `<li><b>åˆ†å­ç”Ÿç‰©å­¦</b>ï¼š${g.mol}</li>`,
      `<li><b>å¾®ç”Ÿç‰©</b>ï¼š${g.mic}</li>`
    ].join('');
  }
  function renderTimetable(){
    const tt = store.get('timetable', []);
    const html = tt.map(b=>`<div class="tt-row"><div class="tt-time">${b.time}</div><div>${escapeHtml(b.title)}</div></div>`).join('');
    $('#ttBox').innerHTML = html;
  }
  const wkPrev = document.getElementById('wkPrev');
  const wkNext = document.getElementById('wkNext');
  if(wkPrev && wkNext){
    wkPrev.onclick = ()=>{ const n = clamp(store.get('curWeekIdx',1)-1, 1, store.get('phaseWeeks',[]).length); store.set('curWeekIdx', n); renderWeekPlan(); };
    wkNext.onclick = ()=>{ const n = clamp(store.get('curWeekIdx',1)+1, 1, store.get('phaseWeeks',[]).length); store.set('curWeekIdx', n); renderWeekPlan(); };
  }

  function majorMinorForWeek(weekIdx){
    const order = ['ç”ŸåŒ–','åˆ†å­ç”Ÿç‰©å­¦','å¾®ç”Ÿç‰©'];
    const major = order[(weekIdx-1)%3];
    const minor = order[(weekIdx)%3];
    return {major, minor};
  }
  const pushWeekBtn = document.getElementById('pushWeek');
  if(pushWeekBtn){ pushWeekBtn.onclick = ()=> dispatchWeek(store.get('curWeekIdx',1)); }
  const pushAllBtn = document.getElementById('pushAll');
  if(pushAllBtn){
    pushAllBtn.onclick = ()=>{
      const ws = store.get('phaseWeeks', []);
      if(!ws.length) return;
      ws.forEach(w=> dispatchWeek(w.idx, false));
      alert('å·²ç”Ÿæˆå…¨éƒ¨ 19 å‘¨çš„å¾…åŠæ¸…å•ï¼ˆå¸¦å„å‘¨æˆªæ­¢æ—¥ï¼‰ã€‚');
      renderTasks();
    };
  }
  function dispatchWeek(idx, showAlert=true){
    const ws = store.get('phaseWeeks', []);
    if(!ws.length) return;
    const w = ws[clamp(idx,1,ws.length)-1];
    const s = parseYMD(w.start);
    const due = i => ymd(new Date(s.getFullYear(), s.getMonth(), s.getDate()+i));
    const {major, minor} = majorMinorForWeek(w.idx);
    const weekdayPack = [0,1,2,3,4].flatMap(i=>[
      {t:`è‹±è¯­äºŒ Â· é˜…è¯»/é•¿éš¾å¥åˆ†é¡¹ï¼ˆ45â€“60minï¼‰`, s:'è‹±è¯­äºŒ', d:due(i), p:'P1', est:50},
      {t:`æ”¿æ²» Â· ã€Š1000é¢˜ã€‹é€‰æ‹© 40â€“50é¢˜`, s:'æ”¿æ²»', d:due(i), est:40},
      {t:`${major} Â· ä¸»ä¿®è®­ç»ƒï¼ˆç²¾è¯»+é¢˜ç›® 90â€“110minï¼‰`, s:major, d:due(i), p:'P1', est:100},
      {t:`${minor} Â· è®°å¿†å·©å›ºï¼ˆå…³é”®æ¦‚å¿µ/åè¯è§£é‡Š 30minï¼‰`, s:minor, d:due(i), est:30}
    ]);
    const weekendPack = [
      {t:`è‹±è¯­äºŒ Â· ä½œæ–‡ç»ƒä¹  1 ç¯‡ï¼ˆA/B è½®æ¢ï¼‰`, s:'è‹±è¯­äºŒ', d:due(5), est:40},
      {t:`${major} Â· ç»¼åˆå¤§é¢˜ä»¿çœŸï¼ˆ90minï¼‰`, s:major, d:due(5), est:90},
      {t:`æ”¿æ²» Â· é”™é¢˜æ•´ç†ï¼ˆ40minï¼‰`, s:'æ”¿æ²»', d:due(5), est:40},
      {t:`å‘¨å¤ç›˜ï¼šé”™é¢˜TOP5é‡åš + å¾—å¤±æ€»ç»“ï¼ˆ60minï¼‰`, s:'å…¶ä»–', d:due(6), est:60},
      {t:`ä¸‹å‘¨ä¸‰ä»¶å¤§äº‹è§„åˆ’ï¼ˆ20minï¼‰`, s:'å…¶ä»–', d:due(6), est:20}
    ];
    [...weekdayPack, ...weekendPack].forEach(x=> addTask({
      id:crypto.randomUUID(), title:x.t, subject:x.s, due:x.d, pri:x.p||'P2', est:x.est||25, done:false, createdAt:Date.now()
    }));
    if(showAlert) { alert(`å·²ç”Ÿæˆï¼šç¬¬ ${w.idx} å‘¨ï¼ˆ${cnRange(w.start,w.end)}ï¼‰çš„å¾…åŠæ¸…å•`); }
  }

  // å¤‡ä»½ / å¯¼å…¥ / æ‰“å° / æ¢å¤
  $('#exportBtn').onclick=()=>{ const data = store.all(); const blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`kaoyan-bio-data-${todayKey()}.json`; a.click(); URL.revokeObjectURL(a.href); };
  $('#importFile').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{ try{
      const raw=JSON.parse(fr.result); for(const k in raw){ localStorage.setItem(k, JSON.stringify(raw[k])); }
      alert('å¯¼å…¥å®Œæˆï¼Œé¡µé¢å°†åˆ·æ–°'); location.reload();
    }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); } }; fr.readAsText(file);
  });
  $('#printBtn').onclick=()=> window.print();
  $('#resetAll').onclick=()=>{ if(confirm('ç¡®è®¤æ¸…ç©ºæœ¬åº”ç”¨çš„æ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')){ Object.keys(localStorage).filter(k=>k.startsWith(KEYP)).forEach(k=>localStorage.removeItem(k)); location.reload(); } };

  // é¦–è®¾å‘å¯¼
  const ob=$('#onboard'); $('#onboardBtn').onclick=()=> ob.showModal && ob.showModal();
  if(!store.get('booted', false)){
    if('HTMLDialogElement' in window && HTMLDialogElement.prototype.showModal){ setTimeout(()=>ob.showModal(), 400); }
    else { ob.setAttribute('open',''); }
  }
  ob.addEventListener('close',()=>{
    if(ob.returnValue==='ok'){
      const dt=$('#obDate').value; if(dt){ store.set('examDate', dt); examDateInput.value=dt; updateCountdown(); buildCalendar(); }
      const gm=+$('#obGoal').value||180; store.set('goalMin', gm); goalMin.value=gm; updateGoalBadge();
      if($('#obSeed').checked){
        ['glycolysis: ç³–é…µè§£','replication: å¤åˆ¶','transcription: è½¬å½•','translation: ç¿»è¯‘','peptidoglycan: è‚½èšç³–','operon: æ“çºµå­']
          .forEach(s=>{ const [w,m]=s.split(':').map(x=>x.trim()); addCard(w,m); });
        insertTemplates();
      }
    }
    store.set('booted', true);
  });

  document.addEventListener('keydown', (e)=>{
    if(e.target && (e.target.matches?.('input, textarea, [contenteditable="true"]'))) return;
    if(e.key && e.key.toLowerCase?.()==='n'){ $('#taskTitle').focus(); }
    if(e.code==='Space'){ e.preventDefault(); $('#startPause').click(); }
  });

  setTimeout(()=>{ drawCharts(); updateKPIs(); updateTodayProgress(); renderWeekPlan(); renderTimetable(); }, 200);
  </script>

  <!-- Firebaseï¼ˆä¿æŒå¯é€‰ï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAV2sDzzYW6qcQ2YCJUQ_IJxeqbAf27Lgs",
      authDomain: "web-1-13c27.firebaseapp.com",
      projectId: "web-1-13c27",
      storageBucket: "web-1-13c27.firebasestorage.app",
      messagingSenderId: "472569141099",
      appId: "1:472569141099:web:a73ca462c677a53824de2e",
      measurementId: "G-DG6YD17SES"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');

    async function userLogin(){
      const email = prompt("è¯·è¾“å…¥é‚®ç®±ï¼š"); if(!email) return;
      const pwd = prompt("è¯·è¾“å…¥å¯†ç ï¼š"); if(!pwd) return;
      try{
        await signInWithEmailAndPassword(auth, email, pwd);
        alert("ç™»å½•æˆåŠŸ");
      }catch(e){
        if(e.code === 'auth/user-not-found'){
          await createUserWithEmailAndPassword(auth, email, pwd);
          alert("æ³¨å†ŒæˆåŠŸå¹¶å·²ç™»å½•");
        }else if(e.code === 'auth/invalid-credential'){
          alert("ç™»å½•å¤±è´¥ï¼šè´¦å·æˆ–å¯†ç ä¸æ­£ç¡®ã€‚");
        }else{
          alert("ç™»å½•å¤±è´¥: "+e.message);
        }
      }
    }
    function userLogout(){ signOut(auth).catch(()=>{}); }
    loginBtn.addEventListener('click', userLogin);
    logoutBtn.addEventListener('click', userLogout);

    const KEY_PREFIX = window.__KE_PREFIX__ || 'ke_bio_v1_';
    function collectLocal(){
      const all={};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && k.startsWith(KEY_PREFIX)){
          all[k] = localStorage.getItem(k);
        }
      }
      return all;
    }
    async function syncToCloud(uid){
      const data = collectLocal();
      await setDoc(doc(db, "users", uid), { data }, { merge:true });
      console.log("âœ… å·²åŒæ­¥åˆ°äº‘ç«¯", new Date().toISOString());
    }
    async function loadFromCloud(uid){
      const snap = await getDoc(doc(db, "users", uid));
      if(!snap.exists()){ console.log("äº‘ç«¯æ— æ•°æ®"); return false; }
      const data = snap.data()?.data || {};
      for(let i=localStorage.length-1;i>=0;i--){
        const k=localStorage.key(i);
        if(k && k.startsWith(KEY_PREFIX)) localStorage.removeItem(k);
      }
      Object.keys(data).forEach(k=> localStorage.setItem(k, data[k]));
      console.log("â¬‡ å·²ä»äº‘ç«¯åŠ è½½æ•°æ®");
      return true;
    }

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        authStatus.textContent = user.email || 'å·²ç™»å½•';
        loginBtn.hidden = true;
        logoutBtn.hidden = false;
        const loaded = await loadFromCloud(user.uid);
        if(loaded && !sessionStorage.getItem('reloadedAfterCloud')){
          sessionStorage.setItem('reloadedAfterCloud','1');
          location.reload(); return;
        }
        if(!window.__syncTimer__){
          window.__syncTimer__ = setInterval(()=>syncToCloud(user.uid), 30000);
        }
        window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden'){ syncToCloud(user.uid).catch(()=>{}); }});
      }else{
        authStatus.textContent = 'æœªç™»å½•';
        loginBtn.hidden = false;
        logoutBtn.hidden = true;
        if(window.__syncTimer__){ clearInterval(window.__syncTimer__); window.__syncTimer__=null; }
      }
    });
  </script>
</body>
</html>
